/* StudyFlow — Core Styles */

body { background: #0B0F1A; }

/* ── iOS/Mobile: Hide scrollbars globally ── */
* {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
*::-webkit-scrollbar {
  display: none;
}

/* Animated background orbs */
.orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.12; animation: float 20s ease-in-out infinite; pointer-events: none; z-index: 0; }
.orb-1 { width: 500px; height: 500px; background: #6B47F5; top: -200px; left: -100px; }
.orb-2 { width: 350px; height: 350px; background: #10B981; bottom: -100px; right: -100px; animation-delay: -7s; }
.orb-3 { width: 250px; height: 250px; background: #F59E0B; top: 40%; left: 60%; animation-delay: -14s; }
@keyframes float { 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(30px,-30px) scale(1.05)} 66%{transform:translate(-20px,20px) scale(0.95)} }

/* Fade-in animation */
.fade-in { opacity:0; transform:translateY(16px); animation:fadeIn .5s ease-out forwards; }
@keyframes fadeIn { to{opacity:1;transform:translateY(0)} }

/* Stagger children */
.stagger>*:nth-child(1){animation-delay:.05s}
.stagger>*:nth-child(2){animation-delay:.1s}
.stagger>*:nth-child(3){animation-delay:.15s}
.stagger>*:nth-child(4){animation-delay:.2s}
.stagger>*:nth-child(5){animation-delay:.25s}

/* Node pulse on roadmap */
.node-pulse { animation: pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(107,71,245,.4)} 50%{box-shadow:0 0 0 10px rgba(107,71,245,0)} }

/* Card hover effect */
.card-hover { transition: all .2s ease; }
.card-hover:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(107,71,245,.1); }

/* Confetti */
.confetti-piece { position:fixed; width:8px; height:8px; border-radius:2px; animation:confettiFall 1.5s ease-out forwards; pointer-events:none; z-index:100; }
@keyframes confettiFall { 0%{opacity:1;transform:translateY(0) rotate(0deg)} 100%{opacity:0;transform:translateY(400px) rotate(720deg)} }

/* Screen management */
.screen { 
    display: none; 
    position: fixed;
    inset: 0;
    background: #0B0F1A;
    overflow-y: auto;
    z-index: 1;
}
.screen.active { display: block; }

/* === Phase 14: Mobile-First UX Fixes === */

/* 1. The 100dvh Viewport Fix */
@media (max-width: 768px) {
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden !important;
        position: fixed;
        width: 100%;
        height: 100%;
        -webkit-user-select: none;
        user-select: none;
        touch-action: none; /* Prevent browser pull-to-refresh and other gestures at root */
    }

    #screen-dashboard.active {
        display: flex !important;
        flex-direction: column !important;
        height: 100dvh !important;
        width: 100vw !important;
        overflow: hidden !important;
        position: relative;
    }

    /* 2. Flexbox Distribution */
    #mobile-app-bar {
        position: relative !important; /* Move from fixed to flex child */
        height: 56px;
        flex-shrink: 0;
        z-index: 40;
    }

    #mobile-tab-bar {
        position: relative !important; /* Move from fixed to flex child */
        height: 64px;
        flex-shrink: 0;
        z-index: 40;
    }

    /* The main content area between bars */
    #screen-dashboard > .relative.z-10 {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        padding: 0 !important; /* Clear all default container padding */
        margin: 0 !important;
        max-width: none !important;
    }

    /* Roadmap content needs to be scrollable */
    #mobile-roadmap-content {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }

    /* Tab panel visibility: .hidden must win over display:flex !important */
    #mobile-roadmap-content.hidden,
    #mobile-focus-panel.hidden,
    #mobile-exams-panel.hidden {
        display: none !important;
    }

    /* Active focus/exams panels need flex layout too */
    #mobile-focus-panel:not(.hidden) {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        padding: 16px !important;
    }

    #mobile-exams-panel:not(.hidden) {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }

    /* 3. Visual Declutter */
    .mobile-hide { display: none !important; }

    /* Fix calendar scroll: chain flex heights from roadmap content → grid */
    #mobile-roadmap-content > .grid {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        min-height: 0 !important;
        gap: 0 !important;
    }
    #mobile-roadmap-content > .grid > div:first-child {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        min-height: 0 !important;
    }
    #mobile-roadmap-content > .grid > div:first-child > div {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        min-height: 0 !important;
    }
    #roadmap-container {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        min-height: 0 !important;
    }

    /* Calendar Grid Container — smooth native scroll, no iOS bounce */
    .grid-day-container {
        flex: 1 !important;
        height: auto !important;
        min-height: 0 !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        touch-action: pan-y !important;
        overscroll-behavior-y: none !important;
        /* NOTE: will-change:transform and transform:translate3d() are intentionally
           removed here. Promoting the scroll container to its own GPU compositing
           layer causes child blocks (which are absolutely positioned) to be clipped
           at the container's layer boundary during fast scroll — blocks appear to
           be "swallowed" before they reach the visible edge. Native scrolling
           without GPU promotion eliminates this clipping artifact.
           -webkit-overflow-scrolling:touch is sufficient for smooth iOS scrolling. */
        border: none !important;
        background: transparent !important;
    }

    /* Kill backdrop-filter on blocks — major perf win on iOS */
    .schedule-block {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }

    /* Tab bar safe-area already applied inline; height accounts for it */
    #mobile-tab-bar {
        height: auto !important;
    }
}

/* Modal — backdrop fade controlled by keyframe animations */
@keyframes backdropIn  { from { opacity: 0; } to { opacity: 1; } }
@keyframes backdropOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes slideDown   { from { transform: translateY(0); } to { transform: translateY(110%); } }

.modal-bg {
    display: none;
    align-items: center;
    justify-content: center;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    backdrop-filter: blur(4px);
    z-index: 100;
}
.modal-bg.active {
    display: flex;
    animation: backdropIn 0.2s ease forwards;
}
/* Closing: keep displayed while animating out, block all pointer events */
.modal-bg.closing {
    display: flex;
    pointer-events: none;
    animation: backdropOut 0.25s ease forwards;
}

/* Loading dots */
.loading-dots span { animation:loadDot 1.4s ease-in-out infinite; }
.loading-dots span:nth-child(2) { animation-delay:.2s; }
.loading-dots span:nth-child(3) { animation-delay:.4s; }
@keyframes loadDot { 0%,80%,100%{opacity:.3;transform:scale(.8)} 40%{opacity:1;transform:scale(1.2)} }

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#121829}
::-webkit-scrollbar-thumb{background:#232B44;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#6B47F5}

/* Shake animation */
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

/* Input fields */
/* font-size:16px is mandatory — prevents iOS Safari from auto-zooming on focus */
.input-field { width:100%; background:rgba(11,15,26,.6); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:12px 16px; color:white; outline:none; transition:border-color .2s; font-size:16px; }
.input-field:focus { border-color:#6B47F5; }
.input-field::placeholder { color:rgba(255,255,255,.3); }

/* Error text */
.error-text { color:#FB7185; font-size:12px; margin-top:4px; display:none; }
.error-text.visible { display:block; }

/* Onboarding Wizard Components */
.onb-hobby-tag, .onb-peak-tag {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.onb-hobby-tag:hover, .onb-peak-tag:hover {
    background-color: rgba(107, 71, 245, 0.1);
    border-color: rgba(107, 71, 245, 0.3);
    transform: translateY(-1px);
}

.onb-hobby-tag.bg-accent-500\/30, .onb-peak-tag.bg-accent-500\/30 {
    background-color: rgba(107, 71, 245, 0.2) !important;
    border-color: #6B47F5 !important;
    color: white;
    box-shadow: 0 0 15px rgba(107, 71, 245, 0.15);
}

/* Range Input Styling */
input[type="range"] {
    -webkit-appearance: none;
    background: transparent;
}

input[type="range"]::-webkit-slider-runnable-track {
    width: 100%;
    height: 6px;
    background: rgba(18, 24, 41, 0.6);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 18px;
    width: 18px;
    border-radius: 50%;
    background: #6B47F5;
    cursor: pointer;
    margin-top: -7px;
    box-shadow: 0 0 10px rgba(107, 71, 245, 0.3);
    transition: transform 0.1s ease;
}

input[type="range"]:active::-webkit-slider-thumb {
    transform: scale(1.2);
}

/* Swipe-to-delete */
.swipe-container {
    position: relative;
    overflow: hidden;
    touch-action: pan-y;
}

.swipe-content {
    position: relative;
    z-index: 10;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: inherit;
}

.delete-reveal-btn {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 80px;
    background: #F43F5E;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
    border-radius: 0 14px 14px 0;
    font-weight: bold;
    font-size: 12px;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.schedule-block.swiped .swipe-content {
    transform: translateX(-80px);
}

.schedule-block.swiped .delete-reveal-btn {
    transform: translateX(0);
}

/* Hourly Grid — Apple Calendar style */
.calendar-grid {
    position: relative;
    border-left: 1px solid rgba(255,255,255,0.07);
}

.time-col {
    position: relative;
    flex-shrink: 0;
}

.hour-label {
    position: absolute;
    right: 6px;
    width: 100%;
    text-align: right;
    font-size: 10px;
    font-weight: 400;
    color: rgba(255,255,255,0.28);
    font-variant-numeric: tabular-nums;
    transform: translateY(-50%);
    white-space: nowrap;
    pointer-events: none;
    letter-spacing: 0.01em;
}

.schedule-block {
    position: absolute;
    border-radius: 10px;
    font-size: 11px;
    overflow: hidden;
    /* top transition is intentionally REMOVED from this base rule.
       Reason: iOS Safari's compositor performs a layer reparent when a block switches
       from position:absolute (inside -webkit-overflow-scrolling:touch container) to
       position:fixed (drag mode). During reparent, iOS animates `top` from the old
       container-relative value to the new viewport-relative value using ANY active CSS
       top transition — even when `el.style.transition = 'none'` is set inline in JS.
       The inline suppression is a main-thread operation; the compositor animation runs
       on the compositor thread and ignores it. Result: a ~75px visible jump at drag activation.
       The `top` transition for save-edit repositioning is re-enabled via `.block-repositioning`
       class, which is toggled by JS only when an edit-modal save occurs (not during drag). */
    transition: box-shadow 0.15s ease, opacity 0.2s;
    cursor: grab;
    z-index: 10;
    box-sizing: border-box;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.08);
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    /* pan-y: allow native vertical scroll when swiping on blocks.
       During active drag (long press), JS sets touch-action:none on the container
       and calls preventDefault() on touchmove to block scroll. */
    touch-action: pan-y;
    -webkit-user-select: none;
    user-select: none;
    /* Suppress iOS long-press callout (copy/paste/define menu) */
    -webkit-touch-callout: none;
    /* NOTE: will-change:transform and transform:translate3d() are intentionally
       NOT set here. Promoting every block to its own GPU compositing layer causes
       the browser to clip blocks at the scrolling container's layer boundary during
       fast scroll (cards appear "swallowed"). interact.js applies transform:translateY()
       during drag only — that is sufficient to trigger GPU compositing for the duration
       of the drag gesture without keeping every block promoted permanently. */
}

.schedule-block:active {
    cursor: grabbing;
    z-index: 50;
}

.schedule-block:hover:not(:active) {
    filter: brightness(1.08);
    z-index: 20;
    box-shadow: 0 4px 14px rgba(0,0,0,0.35);
}

/* Hide interaction markers */
.schedule-block::after {
    display: none;
}

/* Done State */
.is-completed {
    opacity: 0.5 !important;
    background: rgba(16, 185, 129, 0.1) !important;
    border-left-color: #10B981 !important;
    pointer-events: none;
}

.is-completed .task-title {
    text-decoration: line-through;
    color: rgba(255,255,255,0.4);
}

.is-completed .task-checkbox {
    background-color: #10B981 !important;
    border-color: #10B981 !important;
    pointer-events: auto; /* Allow unchecking */
}

/* Success "Pop" Animation */
@keyframes success-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); filter: brightness(1.5); }
    100% { transform: scale(1); }
}
.just-completed {
    animation: success-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.block-study { 
    background: rgba(107, 71, 245, 0.2); 
    border-left: 4px solid #6B47F5; 
}

.block-break {
    background: rgba(255, 255, 255, 0.03) !important;
    border-left: 3px solid rgba(255, 255, 255, 0.2) !important;
    opacity: 0.6;
    z-index: 5;
    cursor: default !important;
    pointer-events: none;
}

.block-hobby { 
    background: rgba(245, 158, 11, 0.1); 
    border-left: 3px solid #F59E0B; 
    color: rgba(245, 158, 11, 0.8);
    opacity: 0.7;
}

/* Checkbox State — !important ensures these win over Tailwind utility classes */

/* Pass pointer events through SVG children to the button.
   This ensures interact.js's ignoreFrom: '.task-checkbox' always fires on the
   button element itself — not on a descendant SVG/path that could bypass ignoreFrom
   and cause interact.js to shift block positions before the native click fires. */
.task-checkbox svg,
.task-checkbox svg * {
    pointer-events: none;
}

.task-checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
}

.task-checkbox.checked {
    background-color: #10B981 !important;
    border-color: #10B981 !important;
    animation: check-bounce 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Also catch the is-completed parent context to guarantee green checkbox */
.is-completed .task-checkbox,
.schedule-block[data-is-done="true"] .task-checkbox {
    background-color: #10B981 !important;
    border-color: #10B981 !important;
}

@keyframes check-bounce {
    0% { transform: scale(0.8); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* Ensure touch targets are thumb-friendly */
@media (max-width: 768px) {
    .grid-checkbox {
        width: 32px;
        height: 32px;
    }
}

.block-delayed {
    border-left: 4px dashed #fb7185 !important;
    background: repeating-linear-gradient(
        45deg,
        rgba(251, 113, 133, 0.05),
        rgba(251, 113, 133, 0.05) 10px,
        rgba(251, 113, 133, 0.1) 10px,
        rgba(251, 113, 133, 0.1) 20px
    ) !important;
}

.delayed-badge {
    background: #fb7185;
    color: white;
    font-size: 8px;
    padding: 1px 4px;
    border-radius: 4px;
    font-weight: bold;
    text-transform: uppercase;
    display: inline-block;
}

.grid-day-container {
    margin-bottom: 0;
    /* Height transition removed: the container uses flex:1 layout and animating
       its height causes the entire calendar column to shift on every re-render,
       compounding card position instability. */
}

/* .calendar-grid-wrapper — no transitions needed: nothing animates this
   element's transform, so keeping it on the browser's watchlist is pure overhead. */

.grid-checkbox {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.grid-checkbox:hover {
    transform: scale(1.1);
    background: rgba(16, 185, 129, 0.1);
}

.grid-checkbox:active {
    transform: scale(0.9);
}

/* Current Time Indicator — Apple Calendar style: red line + filled circle on left */
.current-time-line {
    position: absolute;
    left: 0 !important;
    right: 0;
    width: 100% !important;
    height: 2px;
    background: #FF3B30;
    z-index: 8;
    pointer-events: none;
}

/* Apple Calendar red dot on the left edge of the time line */
.current-time-line::before {
    content: '';
    position: absolute;
    left: -4px;
    top: 50%;
    transform: translateY(-50%);
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: #FF3B30;
}

.time-now-label {
    position: absolute;
    left: -45px;
    top: 50%;
    transform: translateY(-50%);
    background: #FF3B30;
    color: white;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 4px;
    border-radius: 4px;
    pointer-events: none;
    font-variant-numeric: tabular-nums;
}

/* === Phase 14: Mobile-First UX === */

/* Remove 300ms tap delay on all interactive elements */
button, a, select, input[type="checkbox"], input[type="radio"], label {
    touch-action: manipulation;
}

/* Bottom Sheet: targeted modals slide up from bottom on mobile */
@keyframes slideUp {
    from { transform: translateY(100%); }
    to   { transform: translateY(0); }
}

@media (max-width: 768px) {
    .modal-sheet.active,
    .modal-sheet.closing {
        align-items: flex-end;
    }
    /* Shared sheet geometry */
    .modal-sheet.active > div,
    .modal-sheet.closing > div {
        border-radius: 24px 24px 0 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto !important;
    }
    /* Open: slide up */
    .modal-sheet.active > div {
        animation: slideUp 0.25s cubic-bezier(0.32, 0.72, 0, 1) forwards;
    }
    /* Close: slide down */
    .modal-sheet.closing > div {
        animation: slideDown 0.25s cubic-bezier(0.32, 0.72, 0, 1) forwards;
    }
}

/* Re-enable top transition for save-edit repositioning only.
 * This class is added by JS (handleSaveBlock in calendar.js) immediately before
 * writing a new style.top value after the user edits a block via the modal.
 * It is removed ~350ms later (after the animation completes) so that drag activation
 * never finds an active top transition. */
.block-repositioning {
    transition: top 0.35s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
}

/* Drag state — zero animations, no transform, no transition.
 * Stripped to bare minimum to isolate jump root cause. */
.dragging {
    z-index: 1001 !important;
}

/* 44×44px minimum touch target for task checkboxes (Apple HIG) */
.task-checkbox {
    position: relative;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Line-clamp for task titles in small calendar blocks */
.schedule-block .task-title-text {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.schedule-block.block-small .task-title-text {
    -webkit-line-clamp: 1;
}

/* ── iOS Calendar Aesthetic (Phase 15) ── */

/* Tab panel fade transition */
#mobile-roadmap-content,
#mobile-focus-panel,
#mobile-exams-panel {
    transition: opacity 0.2s ease-in-out;
}

/* Hour grid row separators (legacy class kept for compatibility) */
.hour-row {
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

/* Notification settings section inside Exams panel */
.notification-settings-section {
    margin-top: 16px;
    padding: 16px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.notification-settings-section h3 {
    font-size: 14px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 6px;
}

.notification-settings-section p {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.4);
    margin-bottom: 12px;
}

.notif-action-btn {
    display: block;
    width: 100%;
    padding: 10px 16px;
    margin-bottom: 8px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    outline: none;
}

.notif-action-btn:last-child {
    margin-bottom: 0;
}

#enable-notif-btn {
    background: rgba(107, 71, 245, 0.25);
    color: #a78bfa;
    border: 1px solid rgba(107, 71, 245, 0.3);
}

#enable-notif-btn:active {
    background: rgba(107, 71, 245, 0.4);
}

#test-notif-btn {
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

#test-notif-btn:active {
    background: rgba(255, 255, 255, 0.1);
}

/* ── Edit Task Modal Inputs ── */
/* font-size:16px is mandatory — prevents iOS Safari from auto-zooming on focus */
.edit-modal-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.07);
    border: none;
    border-radius: 14px;
    padding: 14px 16px;
    color: white;
    font-size: 16px;
    font-family: inherit;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    transition: background 0.15s ease, box-shadow 0.15s ease;
    -webkit-touch-callout: default; /* Allow text selection inside inputs */
}
.edit-modal-input:focus {
    background: rgba(255, 255, 255, 0.11);
    box-shadow: 0 0 0 2px rgba(107, 71, 245, 0.5);
}
/* Ensure the native time/number spinners render in white on dark bg */
.edit-modal-input::-webkit-calendar-picker-indicator {
    filter: invert(1) opacity(0.5);
    cursor: pointer;
}
.edit-modal-input::placeholder {
    color: rgba(255, 255, 255, 0.25);
}
