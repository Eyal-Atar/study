# Architecture

**Analysis Date:** 2026-02-20

## Pattern Overview

**Overall:** Layered REST API + Modular Web Frontend with AI-powered study planning

**Key Characteristics:**
- FastAPI backend with modular route-based organization
- SQLite relational database with user isolation
- Single-page frontend with **Modular ES6 JavaScript** (Phase 5)
- **HttpOnly Cookie-based Authentication** (Phase 6)
- AI integration (Claude/Anthropic) for intelligent study roadmap generation
- Multi-exam support with file uploads (PDFs) and AI content analysis
- Task-based scheduler with day-by-day planning

## Layers

**Presentation (Frontend):**
- Purpose: Single-page application providing user interface for auth, exam management, task tracking, and study planning
- Location: `frontend/`
- Contains: HTML structure, modularized ES6 JavaScript application logic, CSS styles
- Depends on: FastAPI HTTP API endpoints
- Used by: Browser clients accessing the web application

**API Layer (Routes):**
- Purpose: RESTful HTTP endpoints handling user requests and responses
- Location: `backend/auth/routes.py`, `backend/users/routes.py`, `backend/exams/routes.py`, `backend/tasks/routes.py`, `backend/brain/routes.py`
- Contains: Route handlers, request/response marshalling, dependency injection (current user)
- Depends on: Database layer, authentication utilities, business logic (ExamBrain)
- Used by: Frontend, external clients

**Business Logic (Brain/AI Layer):**
- Purpose: Intelligent study planning using Claude API to analyze exams and generate study tasks
- Location: `backend/brain/exam_brain.py`, `backend/brain/scheduler.py`
- Contains: ExamBrain class for AI analysis, PDF extraction, calendar generation, chat logic
- Depends on: Anthropic SDK, PyMuPDF (fitz), database models
- Used by: Brain routes (/generate-roadmap, /brain-chat)

**Authentication & Authorization:**
- Purpose: Secure session management using HttpOnly cookies and Google OAuth
- Location: `backend/auth/routes.py`, `backend/auth/utils.py`, `backend/auth/oauth_config.py`
- Contains: User registration/login, Google OAuth flow, cookie setting/validation, password hashing
- Depends on: Database, Pydantic schemas, Authlib
- Used by: All protected routes via `get_current_user` dependency

**Data Access (Database):**
- Purpose: SQLite connection management, schema initialization, and database interactions
- Location: `backend/server/database.py`, `backend/server/config.py`
- Contains: Connection pooling, schema creation, migrations, index definitions
- Depends on: SQLite3, environment configuration
- Used by: All route handlers and business logic

## Data Flow

**User Authentication Flow (Google OAuth):**

1. User clicks "Sign in with Google" in `frontend/js/auth.js`
2. Frontend redirects to `GET /auth/login/google`
3. Backend redirects user to Google Consent Screen
4. User authorizes; Google redirects to `GET /auth/auth/callback`
5. Backend exchanges code for tokens, fetches user info, and sets **HttpOnly session cookie**
6. Backend redirects user to frontend home
7. Frontend `app.js` checks session status on load via `GET /users/me`

**Exam Creation & File Upload Flow:**

1. User adds exam in `frontend/js/tasks.js` (calls `POST /exams`)
2. Route handler `backend/exams/routes.py` → `create_exam()` validates exam data
3. Exam inserted into `exams` table, linked to current user via `user_id`
4. User uploads PDF (syllabus/past exam) via `POST /exams/{exam_id}/upload`
5. File stored in `backend/uploads/user_{user_id}/exam_{exam_id}/` directory
6. File metadata inserted into `exam_files` table

**AI Roadmap Generation Flow:**

1. User clicks "Generate Roadmap" button in `frontend/js/brain.js`
2. Frontend calls `POST /generate-roadmap`
3. Route handler `backend/brain/routes.py` → `generate_roadmap()` retrieves:
   - All upcoming exams for user from `exams` table
   - Associated files from `exam_files` table
4. Instantiates `ExamBrain` class from `backend/brain/exam_brain.py`
5. ExamBrain extracts text from PDFs using PyMuPDF: `extract_text_from_pdf()`
6. Builds prompt with exam context and calls Claude API
7. Schedule blocks generated by AI are stored in `tasks` table and returned to frontend
8. `frontend/js/calendar.js` renders the new blocks in the Event Calendar
