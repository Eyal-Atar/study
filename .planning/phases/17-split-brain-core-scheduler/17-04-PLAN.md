---
phase: 17-split-brain-core-scheduler
plan: 04
type: execute
wave: 3
depends_on:
  - 17-02
files_modified:
  - index.html
  - frontend/js/brain.js
  - frontend/js/ui.js
autonomous: true
requirements:
  - SB-05

must_haves:
  truths:
    - "User sees a full-page review screen after clicking Generate Roadmap"
    - "Review screen shows topic map per exam with syllabus topics listed"
    - "Review screen shows detected gaps with option to dismiss or add search tasks"
    - "User can click Approve & Generate Schedule to trigger the Strategist"
    - "User can click Cancel to return to dashboard without generating a schedule"
    - "Legacy users with old parsed_context see a banner suggesting re-upload"
  artifacts:
    - path: "index.html"
      provides: "screen-auditor-review HTML section"
      contains: "screen-auditor-review"
    - path: "frontend/js/brain.js"
      provides: "renderAuditorReview(), approveAndRunStrategist(), handleGapActions()"
      contains: "renderAuditorReview"
    - path: "frontend/js/ui.js"
      provides: "showScreen recognizes screen-auditor-review"
  key_links:
    - from: "frontend/js/brain.js"
      to: "index.html"
      via: "renders into #screen-auditor-review DOM elements"
      pattern: "auditor-topic-map|auditor-gaps|gaps-list"
    - from: "frontend/js/brain.js"
      to: "/brain/approve-and-schedule"
      via: "fetch POST on approve button click"
      pattern: "approve-and-schedule"
---

<objective>
Build the Intermediate Review Page — the full-page frontend screen between the Auditor and Strategist that lets users review the AI's content analysis before schedule generation.

Purpose: The review page gives users control over their study plan by showing the topic map, detected gaps, and material coverage. This transparency is a core value of the split-brain architecture — users approve before the schedule is generated.
Output: New screen-auditor-review in index.html, brain.js module for rendering and interaction.
</objective>

<execution_context>
@/Users/eyalatar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-split-brain-core-scheduler/17-RESEARCH.md
@.planning/phases/17-split-brain-core-scheduler/17-02-SUMMARY.md
@index.html
@frontend/js/ui.js
@frontend/js/tasks.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create screen-auditor-review HTML and brain.js module</name>
  <files>index.html, frontend/js/brain.js</files>
  <action>
**In index.html:**

Add a new screen section (following existing screen pattern — `<div id="screen-..." class="screen">`):

```html
<div id="screen-auditor-review" class="screen">
  <div class="relative z-10 min-h-screen flex flex-col p-4 max-w-2xl mx-auto">
    <h2 class="text-xl font-bold mb-4 text-white">Review Your Study Plan</h2>

    <!-- Legacy user banner (hidden by default) -->
    <div id="auditor-legacy-banner" class="hidden bg-yellow-900/50 border border-yellow-600 rounded-lg p-3 mb-4 text-yellow-200 text-sm">
      We used your previously uploaded context. For better gap detection, upload your full study materials.
    </div>

    <!-- Topic map per exam -->
    <div id="auditor-topic-map" class="mb-6"></div>

    <!-- Detected gaps -->
    <div id="auditor-gaps" class="mb-6">
      <h3 class="text-lg font-semibold mb-2 text-white">Detected Gaps</h3>
      <p id="auditor-no-gaps" class="hidden text-green-400 text-sm">No gaps detected — all syllabus topics have matching study materials.</p>
      <div id="gaps-list" class="space-y-2"></div>
    </div>

    <!-- Task summary -->
    <div id="auditor-task-summary" class="mb-6 text-gray-300 text-sm"></div>

    <!-- Action buttons -->
    <div class="flex gap-3 mt-auto sticky bottom-4">
      <button id="btn-cancel-review" class="flex-1 px-4 py-3 rounded-xl bg-gray-700 text-white font-medium">Cancel</button>
      <button id="btn-approve-schedule" class="flex-1 px-4 py-3 rounded-xl bg-indigo-600 text-white font-medium">Approve & Generate Schedule</button>
    </div>
  </div>
</div>
```

Style this consistently with existing screens (dark theme, Tailwind classes, max-w-2xl centered, rounded cards).

**Create `frontend/js/brain.js` (new ES6 module):**

1. **`renderAuditorReview(auditorData)`:** Takes the Auditor response `{tasks, gaps, topic_map}` and renders it into the review screen DOM elements:
   - **Topic map section:** For each exam in `topic_map`, render a card with the exam name and a list of topics as pills/tags. If a topic has a matching task, show it in green; if it's a gap, show in amber.
   - **Gaps section:** For each gap, render a card showing the exam name, topic, and description. Each gap card has two buttons: "Dismiss" (removes the gap from the list) and "Add Search Task" (adds a synthetic task with title "Search for: [topic]" to the approved list).
   - If no gaps, show the `#auditor-no-gaps` message.
   - **Task summary:** Show total task count, total estimated hours, exam breakdown.
   - **Legacy banner:** If the Auditor output was based on `parsed_context` (detect by checking if any exam's topic_map seems thin or auditor included a "legacy" flag), show `#auditor-legacy-banner`.

2. **`getApprovedTasks()`:** Returns the current list of tasks after user edits (dismissals, added search tasks). Store the working task list in a module-level variable.

3. **`approveAndRunStrategist()`:** Called when "Approve & Generate Schedule" is clicked.
   - Show loading overlay
   - POST to `/brain/approve-and-schedule` with `{approved_tasks: getApprovedTasks()}`
   - On success: update local store with new schedule and tasks, call `showScreen('screen-dashboard')`, refresh calendar
   - On error: show toast/alert with error message, hide loading overlay

4. **Event listeners in an `initBrainUI()` function:**
   - `#btn-cancel-review` → `showScreen('screen-dashboard')`
   - `#btn-approve-schedule` → `approveAndRunStrategist()`

5. **Export** `renderAuditorReview`, `initBrainUI`, and `approveAndRunStrategist`.

Add `<script type="module">` import for brain.js in index.html (follow existing pattern for how tasks.js, ui.js are loaded).
  </action>
  <verify>
Open the app in browser. Manually call `renderAuditorReview(mockData)` from console with sample data:
```javascript
renderAuditorReview({
  tasks: [{exam_id: 1, title: "Review Calculus Ch1", topic: "Limits", estimated_hours: 1.5, focus_score: 7}],
  gaps: [{exam_id: 1, topic: "Integration", description: "Topic in syllabus but no study material found"}],
  topic_map: {"1": ["Limits", "Derivatives", "Integration"]}
});
showScreen('screen-auditor-review');
```
Review screen should render with topic map, gap card with Dismiss/Add Search buttons, and task summary.
  </verify>
  <done>Review screen renders topic map, gaps with dismiss/add actions, task summary. Approve button triggers Strategist call. Cancel returns to dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Wire generateRoadmap to Auditor flow and update screen transitions</name>
  <files>frontend/js/tasks.js, frontend/js/ui.js</files>
  <action>
**In tasks.js:**

1. Modify `generateRoadmap()` function: After the POST to `/brain/generate-roadmap` returns, instead of rendering the schedule immediately:
   - Check response for `status === "auditor_complete"`
   - If auditor_complete: import and call `renderAuditorReview(response)` from brain.js, then `showScreen('screen-auditor-review')`
   - If error: show error toast, stay on current screen
   - Remove or bypass the old path that immediately renders a schedule from generateRoadmap (the schedule now comes from approve-and-schedule)

2. Keep backward compatibility: If the response has `status === "schedule_complete"` (old format), handle it as before. This allows a graceful transition.

**In ui.js:**

3. Ensure `showScreen()` handles `'screen-auditor-review'` — it should already work since it uses `document.querySelectorAll('.screen')` to hide all, then shows the target. No change needed unless there's a whitelist or special handling. Verify and add if necessary.

4. If there's bottom tab navigation (Phase 14), ensure the auditor review screen hides the bottom tabs (it's a full-page flow, not a tabbed screen). Add a class check or explicit hide in `showScreen()` when the target is `screen-auditor-review`.
  </action>
  <verify>
Full flow test:
1. Add exams with uploaded PDFs
2. Click "Generate Roadmap"
3. Loading overlay should appear while Auditor runs
4. After Auditor completes, review screen should appear with topic map and gaps
5. Click "Approve & Generate Schedule" — loading overlay, then dashboard with calendar
6. Click Cancel — returns to dashboard without schedule changes
  </verify>
  <done>Generate Roadmap triggers Auditor, shows review page. Approve triggers Strategist. Full flow works end-to-end from dashboard through review to scheduled calendar.</done>
</task>

</tasks>

<verification>
1. screen-auditor-review renders correctly on mobile and desktop
2. Topic map shows topics grouped by exam
3. Gaps show dismiss and add-search-task buttons that work
4. Approve button calls approve-and-schedule and returns to dashboard
5. Cancel button returns to dashboard without changes
6. Legacy banner shows when using old parsed_context data
7. Bottom tabs hidden during review (if applicable)
8. Loading overlay shown during both AI calls
</verification>

<success_criteria>
- Users see their study plan analysis before schedule generation
- Gap detection results are interactive (dismiss/add search tasks)
- Full flow: Generate → Review → Approve → Schedule works without errors
- Mobile-friendly layout consistent with existing app style
- State persists across page refresh (via auditor-draft endpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/17-split-brain-core-scheduler/17-04-SUMMARY.md`
</output>
