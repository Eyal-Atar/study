---
phase: 17-split-brain-core-scheduler
plan: 03
type: execute
wave: 3
depends_on: ["17-01", "17-02"]
files_modified:
  - index.html
  - frontend/js/tasks.js
  - backend/brain/exam_brain.py
  - backend/brain/routes.py
  - backend/brain/scheduler.py
autonomous: true
requirements: [SB-05, SB-06, SB-07, SB-08]

must_haves:
  truths:
    - "New screen-auditor-review is visible in index.html and accessible via showScreen"
    - "Review screen renders topic maps, tasks, and detected gaps"
    - "Users can dismiss gaps or add 'Search Task' for missing material"
    - "Approve button triggers Strategist and final schedule generation"
    - "Strategist prompt distributes tasks across days and handles focus-score windows"
    - "Strategist generates padding tasks to hit the 360-minute daily quota"
    - "Scheduler.py places tasks with focus_score >= 8 in peak productivity windows"
    - "Final schedule is persisted and visible on the dashboard"
  artifacts:
    - path: "index.html"
      provides: "Intermediate Review Screen markup"
      contains: "screen-auditor-review"
    - path: "backend/brain/exam_brain.py"
      provides: "_build_strategist_prompt and call_strategist"
      contains: "call_strategist"
    - path: "backend/brain/scheduler.py"
      provides: "Focus-score-aware window placement"
      contains: "focus_score"
  key_links:
    - from: "frontend/js/tasks.js"
      to: "backend/brain/routes.py"
      via: "POST /brain/approve-and-schedule"
      pattern: "/brain/approve-and-schedule"
    - from: "backend/brain/routes.py"
      to: "backend/brain/exam_brain.py"
      via: "call_strategist invocation"
      pattern: "call_strategist"
    - from: "backend/brain/exam_brain.py"
      to: "backend/brain/scheduler.py"
      via: "generate_multi_exam_schedule with pre-assigned days"
      pattern: "generate_multi_exam_schedule"
---

<objective>
Implement the Strategic Scheduling (Strategist) layer and the Intermediate Review UI.

Purpose: This plan completes the "Split-Brain" flow. After the Auditor identifies tasks and gaps, the user reviews them on a new screen. Once approved, the Strategist (API Call 2) assigns tasks to days, considering focus scores and peak productivity. The Enforcer (scheduler.py) then places these tasks into specific hourly slots, ensuring a strict 6-hour daily study quota.

Output: A new review screen in the frontend, a Strategist implementation in the backend, and an updated scheduler that respects cognitive load and daily quotas.
</objective>

<execution_context>
@/Users/eyalatar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-split-brain-core-scheduler/17-CONTEXT.md
@.planning/phases/17-split-brain-core-scheduler/17-RESEARCH.md
@.planning/phases/17-split-brain-core-scheduler/17-01-SUMMARY.md
@.planning/phases/17-split-brain-core-scheduler/17-02-SUMMARY.md
@index.html
@frontend/js/tasks.js
@backend/brain/exam_brain.py
@backend/brain/routes.py
@backend/brain/scheduler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Intermediate Review Screen (UI & Logic)</name>
  <files>index.html, frontend/js/tasks.js</files>
  <action>
**index.html:**
- Add `<div id="screen-auditor-review" class="screen">` following the pattern in the research.
- Include sections for: Topic Map (visual summary), Detected Gaps, and Proposed Tasks.
- Add "Cancel" and "Approve & Generate Schedule" buttons.

**frontend/js/tasks.js:**
- Implement `renderAuditorReview(data)`:
  - Takes the Auditor JSON output.
  - Renders a list of gaps with two actions: "Dismiss" (remove from UI) and "Add Search Task" (adds a task to the `tasks` list like "Search for material on [Topic]").
  - Renders the full task list grouped by exam.
- Update `generateRoadmap()` (or the handler for the generate button):
  - After receiving the Auditor response, store it in `window._auditorDraft`.
  - Call `renderAuditorReview(window._auditorDraft)`.
  - Switch to `screen-auditor-review`.
- **Draft Resumption**:
  - On application initialization (in `tasks.js` or `app.js` init), call `GET /brain/auditor-draft`.
  - If a draft exists, show a "Resume Review" notification/banner OR automatically call `renderAuditorReview()` and switch to the review screen if the user has no current schedule.
- Implement `approveSchedule()`:
  - Collects all "approved" tasks (the original tasks + any newly added "Search" tasks).
  - POSTs to `/brain/approve-and-schedule` with `{ approved_tasks }`.
  - On success, switches to `screen-dashboard` and triggers a full calendar refresh.
  </action>
  <verify>
1. Click "Generate Roadmap" on Dashboard.
2. Verify you are taken to the Review Screen.
3. Refresh the page. Verify the system offers to resume the review or restores the review screen.
4. Verify gaps are shown and "Add Search Task" works (adds to the task list).
5. Verify "Cancel" returns to Dashboard.
  </verify>
  <done>The Intermediate Review Screen is functional, allowing users to see what the AI found and make minor adjustments before committing to a schedule.</done>
</task>

<task type="auto">
  <name>Task 2: Strategist Prompt and Call Implementation</name>
  <files>backend/brain/exam_brain.py</files>
  <action>
Implement the Strategist call in `ExamBrain`:

1. **_build_strategist_prompt(self, approved_tasks: list, days_available: int) -> str**:
   - Requirements: Distribute tasks across available days.
   - **Context**: Pass the Auditor's `reasoning` for each focus score to help the Strategist decide on optimal placement.
   - Rules: Focus-score placement (>=8 in peak window), interleave subjects, respect dependencies.
   - **Internal Priority**: Instruct the AI to assign an `internal_priority` (1-100) or `sort_order` to each task. This is used by the Enforcer if tasks exceed the daily study budget.
   - **Daily Quota Padding**: Instruct the AI to generate padding tasks (label: "General Review: [Subject]") if the total approved task hours are less than the budget (`days_available * neto_study_hours`).
   - Output format: JSON array of `{ task_index, day_index, internal_priority, title?, exam_id?, estimated_hours? }`.
   - Reference the pattern provided in `17-RESEARCH.md`.

2. **call_strategist(self, approved_tasks: list) -> list**:
   - Execute the Claude Haiku call.
   - Parse the JSON response.
   - Map `task_index` back to the actual task objects from `approved_tasks`.
   - Return a list of task objects, each augmented with a `day_index` and `internal_priority`.
  </action>
  <verify>
Unit test `call_strategist` with a sample approved task list. Verify that tasks are assigned `day_index` and `internal_priority`, and that padding tasks are generated if the input list is short.
  </verify>
  <done>ExamBrain can perform the Strategist call, turning a list of tasks into a day-by-day strategic plan with daily quota enforcement.</done>
</task>

<task type="auto">
  <name>Task 3: Approve Route & Scheduler Update</name>
  <files>backend/brain/routes.py, backend/brain/scheduler.py</files>
  <action>
**backend/brain/routes.py:**
- Add `POST /brain/approve-and-schedule` endpoint.
- Logic:
  1. Call `brain.call_strategist(approved_tasks)`.
  2. The Strategist returns tasks with `day_index`. Convert `day_index` to actual `day_date` strings starting from today.
  3. Clear existing `tasks` and `schedule_blocks` for the user.
  4. Save the new tasks (including padding tasks) to the `tasks` table.
  5. Run `generate_multi_exam_schedule()`.
  6. Save the resulting schedule blocks to the `schedule_blocks` table.
  7. Return `{ message, tasks, schedule }`.

**backend/brain/scheduler.py:**
- Update the window-filling loop:
  - When picking tasks for a window, check `window.is_peak` (needs to be added to `WiredWindow` or calculated in the loop based on `user['peak_productivity']`).
  - If `window.is_peak` is True, prioritize tasks where `focus_score >= 8`.
  - **Dependency Awareness**: When picking between tasks assigned to the same day, ensure `dependency_id` is respected (prerequisite task must be scheduled in an earlier window).
  - Ensure the "Exclusive Focus Zone" logic (focusing on the closest exam) still takes precedence or is integrated with the focus-score priority.
  - **Overflow (Push-to-Next-Day)**: If a day's quota (`day_limit_min`) is reached and tasks remain assigned to that day, move the remaining tasks to the next day's task pool. Use the AI-assigned `internal_priority` to decide which tasks stay and which are pushed.
  - **Strict Bucket Fill**: If a window has remaining time and no tasks are available for that day, ensure the Strategist's padding tasks are used to fill the gap.
  </action>
  <verify>
1. Complete the full flow: Generate -> Review -> Approve.
2. Verify the final schedule in the dashboard.
3. Test a scenario where tasks exceed 6 hours in a day. Verify that low-priority tasks are pushed to the next day.
4. Verify peak productivity windows have high focus-score tasks.
  </verify>
  <done>The Strategist and Enforcer work together to create a high-quality, high-concentration schedule that fills the user's daily study quota.</done>
</task>

</tasks>

<verification>
- Review screen correctly displays Auditor data
- "Add Search Task" correctly modifies the pending task list
- Strategist call assigns tasks to days and generates padding
- Scheduler places high focus-score tasks in peak windows
- Final schedule is saved and rendered on dashboard
- All Phase 17 Part 3 & 4 requirements met
</verification>

<success_criteria>
The Split-Brain architecture is fully functional. The user can now see a Knowledge Audit, adjust it, and generate a strategic schedule that respects cognitive load and guarantees daily study volume.
</success_criteria>

<output>
After completion, create `.planning/phases/17-split-brain-core-scheduler/17-03-SUMMARY.md`
</output>
