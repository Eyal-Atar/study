---
phase: 17-split-brain-core-scheduler
plan: 03
type: execute
wave: 3
depends_on:
  - 17-02
files_modified:
  - backend/brain/exam_brain.py
  - backend/brain/scheduler.py
  - backend/brain/routes.py
autonomous: true
requirements:
  - SB-06
  - SB-07

must_haves:
  truths:
    - "Strategist distributes approved tasks across available days with exam interleaving"
    - "High focus_score tasks (>=8) placed in user's peak_productivity window"
    - "Python Enforcer validates daily quota is met and inserts padding tasks if short"
    - "Hobby and break blocks are hard-locked and never subtracted from study quota"
    - "POST /brain/approve-and-schedule accepts approved tasks and returns a full schedule"
  artifacts:
    - path: "backend/brain/exam_brain.py"
      provides: "call_strategist() method and _build_strategist_prompt()"
      contains: "call_strategist"
    - path: "backend/brain/scheduler.py"
      provides: "Focus-score-aware placement, hard quota enforcement, padding task generation"
      contains: "focus_score"
    - path: "backend/brain/routes.py"
      provides: "POST /brain/approve-and-schedule route"
      contains: "approve-and-schedule"
  key_links:
    - from: "backend/brain/routes.py"
      to: "backend/brain/exam_brain.py"
      via: "calls call_strategist(approved_tasks)"
      pattern: "call_strategist"
    - from: "backend/brain/scheduler.py"
      to: "backend/server/database.py"
      via: "reads focus_score from tasks, reads peak_productivity from users"
      pattern: "focus_score"
---

<objective>
Implement the Strategist (API Call 2) and Python Enforcer — the time distribution engine that takes approved tasks and produces a cognitively-balanced schedule with hard daily quota enforcement.

Purpose: The Strategist is the second half of the split-brain architecture. It receives user-approved tasks from the Auditor review and distributes them across days with focus-score awareness. The Enforcer then validates the output meets the strict daily study quota and injects padding tasks and breaks.
Output: Working Strategist call, Enforcer validation, approve-and-schedule API route.
</objective>

<execution_context>
@/Users/eyalatar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-split-brain-core-scheduler/17-RESEARCH.md
@.planning/phases/17-split-brain-core-scheduler/17-02-SUMMARY.md
@backend/brain/exam_brain.py
@backend/brain/scheduler.py
@backend/brain/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Strategist call and focus-score-aware scheduler</name>
  <files>backend/brain/exam_brain.py, backend/brain/scheduler.py</files>
  <action>
**In exam_brain.py:**

1. **Add `_build_strategist_prompt(self, approved_tasks, days_available)`:** Use the prompt template from 17-RESEARCH.md. Key rules in prompt:
   - Distribute tasks across N days
   - Place focus_score >= 8 tasks in peak productivity window
   - Respect dependency_id ordering
   - Interleave exam subjects (no same exam for too many consecutive slots)
   - Generate padding tasks if total task hours < days * neto_study_hours
   - Strategist assigns tasks to days only (day_index), NOT to specific times — Python handles time placement
   - Return JSON array of `{task_index, day_index, title (padding only), exam_id (padding only), estimated_hours (padding only)}`

2. **Add `async call_strategist(self, approved_tasks)`:**
   - Compute days_available from today to the earliest exam date
   - Call Claude Haiku with strategist prompt
   - Parse JSON response (same fence-stripping + fallback as Auditor)
   - Return the day-assignment list

**In scheduler.py:**

3. **Add focus_score-aware window placement:** In `generate_multi_exam_schedule()` (or in a new post-processing step called by the approve route):
   - Parse user's `peak_productivity` to time range: Morning=07:00-12:00, Afternoon=12:00-17:00, Evening=17:00-22:00. Default to Morning if unrecognized.
   - When filling a window that overlaps peak range: prefer tasks with `focus_score >= 8` from the day's assigned tasks
   - When filling off-peak windows: prefer tasks with `focus_score < 8`
   - Fallback: if no matching focus-score task available, use standard linear scan (existing behavior)

4. **Add hard daily quota enforcement (Python Enforcer):**
   - After filling a day with real tasks, compute `used_minutes` for study blocks
   - If `used_minutes < neto_study_hours * 60 - 45` (more than 45 min gap): insert padding task blocks. Padding tasks have `block_type='study'`, `task_id=None`, title like "General Review: [subject]". They are synthetic `ScheduleBlock` entries.
   - Hobby block remains hard-locked at its configured time regardless of fill level. Hobby time never subtracts from study quota.
   - Pomodoro breaks (15 min every 90 min) and long breaks (30 min every 3 hours) continue to be injected by Python, NOT by the AI.

Important: Do NOT remove the existing `generate_multi_exam_schedule()` function — extend it or add a parallel path for the split-brain flow. The Enforcer is a validation/fix-up pass that runs AFTER the Strategist's day assignments are converted to timed blocks.
  </action>
  <verify>
Create test scenario: user with 3 exams, 6 hours daily quota, morning peak_productivity. After Strategist + Enforcer:
- Each day should have close to 360 minutes of study blocks
- High focus_score tasks should cluster in morning windows
- Padding tasks should appear if real tasks don't fill the quota
- Hobby block should be present and not counted against study quota
  </verify>
  <done>Strategist assigns tasks to days with interleaving. Scheduler places high-focus tasks in peak windows. Enforcer fills gaps with padding. Daily quota is enforced as a floor.</done>
</task>

<task type="auto">
  <name>Task 2: Create approve-and-schedule API route</name>
  <files>backend/brain/routes.py</files>
  <action>
1. **Add `POST /brain/approve-and-schedule`:** This is the second step of the split-brain flow, called after the user approves on the intermediate review page.

   Request body: `{"approved_tasks": [...]}` — the list of tasks the user approved (may have modifications: dismissed gaps, added search tasks).

   Implementation:
   a. Save approved tasks to the `tasks` table (with focus_score and dependency_id from Auditor output)
   b. Call `brain.call_strategist(approved_tasks)` to get day assignments
   c. Convert day assignments to timed schedule blocks using the existing `generate_multi_exam_schedule()` logic (extended with focus-score placement from Task 1)
   d. Run the Enforcer validation pass (padding + breaks)
   e. Save schedule blocks to `schedule_blocks` table. Preserve `push_notified` pattern: blocks in the past get `is_notified=1`, future blocks get `is_notified=0` (per Research open question 4).
   f. Clear `auditor_draft` from exams table (draft consumed)
   g. Return `{"status": "schedule_complete", "schedule": [...], "tasks": [...]}` with the generated schedule and saved tasks

2. Error handling: Wrap Strategist call in try/except. If it fails, return `{"status": "error", "message": "Schedule generation failed: ..."}` with HTTP 500. The approved tasks are already saved to DB so the user doesn't lose their approval.

3. Delete any old schedule blocks for this user before inserting new ones (same as current regenerate behavior).
  </action>
  <verify>
```bash
curl -X POST http://localhost:8000/brain/approve-and-schedule \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"approved_tasks": [...]}'
```
Response should contain `{"status": "schedule_complete", "schedule": [...]}` with timed blocks that fill the daily quota.
  </verify>
  <done>approve-and-schedule route accepts approved tasks, runs Strategist + Enforcer, saves schedule, returns complete timed schedule.</done>
</task>

</tasks>

<verification>
1. Strategist prompt produces valid day-assignment JSON
2. Focus-score tasks placed in peak productivity windows
3. Daily quota enforced with padding tasks when needed
4. Hobby blocks preserved and not counted against study quota
5. approve-and-schedule route returns complete schedule
6. Schedule blocks saved with correct push_notified values
7. Old schedule blocks cleared before new insertion
</verification>

<success_criteria>
- Strategist distributes tasks across days with interleaving and dependency respect
- High focus_score tasks cluster in user's peak productivity window
- Every scheduled day reaches within 45 min of the daily quota (or is fully padded)
- approve-and-schedule API route works end-to-end
- No regressions in existing schedule regeneration
</success_criteria>

<output>
After completion, create `.planning/phases/17-split-brain-core-scheduler/17-03-SUMMARY.md`
</output>
