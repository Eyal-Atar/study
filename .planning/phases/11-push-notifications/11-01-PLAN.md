---
phase: 11-push-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/manifest.json
  - frontend/sw.js
  - frontend/index.html
  - frontend/js/app.js
autonomous: true
requirements: [INFRA-01, INFRA-03]

must_haves:
  truths:
    - "Browser shows 'Add to Home Screen' / install prompt for the app"
    - "App loads its shell (HTML/CSS/JS) without network via service worker cache"
    - "A persistent 'Offline' indicator appears when the device is offline"
    - "Push notifications received in Service Worker are displayed as OS-level notifications"
  artifacts:
    - path: "frontend/manifest.json"
      provides: "PWA manifest with name, icons, theme, display mode"
      contains: "standalone"
    - path: "frontend/sw.js"
      provides: "Service Worker: App Shell caching, offline fallback, push event handler"
      min_lines: 60
    - path: "frontend/index.html"
      provides: "manifest link tag, service-worker registration script, offline indicator element"
      contains: "rel=\"manifest\""
    - path: "frontend/js/app.js"
      provides: "navigator.serviceWorker.register call on load"
  key_links:
    - from: "frontend/index.html"
      to: "frontend/manifest.json"
      via: "<link rel='manifest'>"
      pattern: "rel=['\"]manifest['\"]"
    - from: "frontend/js/app.js"
      to: "frontend/sw.js"
      via: "navigator.serviceWorker.register"
      pattern: "serviceWorker\\.register"
    - from: "frontend/sw.js"
      to: "App Shell files"
      via: "cache.addAll in install event"
      pattern: "cache\\.addAll"
---

<objective>
Create PWA foundation: manifest.json (enables "Add to Home Screen"), a Service Worker that caches the App Shell for offline access, and an offline indicator shown to the user when the network is unavailable.

Purpose: INFRA-01 (PWA installability) and INFRA-03 (basic offline support) are the prerequisite infrastructure for push notifications — the SW also receives push events in Plan 02.
Output: manifest.json, sw.js, updated index.html and app.js
</objective>

<execution_context>
@/Users/eyalatar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-push-notifications/11-CONTEXT.md
@frontend/index.html
@frontend/js/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manifest.json and Service Worker (sw.js)</name>
  <files>frontend/manifest.json, frontend/sw.js</files>
  <action>
Create `frontend/manifest.json`:
```json
{
  "name": "StudyFlow",
  "short_name": "StudyFlow",
  "description": "AI-powered study planner",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#0f1117",
  "theme_color": "#6366f1",
  "icons": [
    { "src": "/static/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/static/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

Note on icons: The backend already serves `frontend/` as static files at `/`. Create placeholder 192x192 and 512x512 PNG icons in `frontend/static/` — simple indigo squares with "SF" text are fine (or generate via a small Python script using PIL if available; if not, create 1x1 pixel valid PNG placeholders at minimum). The manifest will be valid regardless.

Create `frontend/sw.js` with:

1. **CACHE_NAME constant** — `'studyflow-shell-v1'`

2. **APP_SHELL array** — list of files to cache:
   `['/', '/static/css/styles.css', '/static/js/app.js', '/static/js/auth.js', '/static/js/brain.js', '/static/js/calendar.js', '/static/js/interactions.js', '/static/js/store.js', '/static/js/tasks.js', '/static/js/ui.js']`

   Note: FastAPI serves frontend files from `/static/` path prefix. Use the actual URLs the browser fetches.

3. **`install` event handler** — opens CACHE_NAME cache, calls `cache.addAll(APP_SHELL)`, calls `self.skipWaiting()`.

4. **`activate` event handler** — deletes old caches (keys not matching CACHE_NAME), calls `clients.claim()`.

5. **`fetch` event handler** — cache-first strategy for navigation and static assets:
   - Match against cache first
   - If hit: return cached response
   - If miss: `fetch(event.request)` then cache the response clone for future requests
   - If fetch fails (offline) and request is a navigation (HTML): return cached `/` fallback
   - For API calls (`/api/` or FastAPI route paths like `/tasks`, `/exams`): network-first, serve from cache if network fails, return `new Response('{"offline":true}', {status:503})` if not cached

6. **`push` event handler** — receives push payload from server:
   ```js
   self.addEventListener('push', event => {
     const data = event.data ? event.data.json() : {};
     const title = data.title || 'StudyFlow';
     const options = {
       body: data.body || 'Time to study!',
       icon: '/static/icon-192.png',
       badge: '/static/icon-192.png',
       data: { url: data.url || '/' }
     };
     event.waitUntil(self.registration.showNotification(title, options));
   });
   ```

7. **`notificationclick` event handler** — opens the app URL from notification data.
  </action>
  <verify>
Open browser DevTools → Application → Service Workers and check `frontend/sw.js` parses without syntax errors. Also check Application → Manifest to confirm manifest.json is valid.
Run: `python3 -c "import json; json.load(open('frontend/manifest.json'))"` from project root — should exit 0.
  </verify>
  <done>
manifest.json is valid JSON with name, short_name, display:standalone, icons array. sw.js exists with install/activate/fetch/push/notificationclick event handlers and no syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire manifest and Service Worker into the app</name>
  <files>frontend/index.html, frontend/js/app.js</files>
  <action>
**frontend/index.html — add inside `<head>`:**

1. Add manifest link (after existing meta tags):
   ```html
   <link rel="manifest" href="/manifest.json">
   <meta name="theme-color" content="#6366f1">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   <meta name="apple-mobile-web-app-title" content="StudyFlow">
   ```

2. Add offline indicator element — place this as the first child inside `<body>`, before any other div:
   ```html
   <div id="offline-banner" style="display:none;" class="fixed top-0 left-0 right-0 z-50 bg-coral-500/90 text-white text-center text-sm py-2 font-medium">
     You are offline — schedule is read-only
   </div>
   ```
   Note: `coral-500` is already in the Tailwind config based on existing usage in the project. Use `bg-red-500` as fallback if coral is not defined as a custom color.

**frontend/js/app.js — add Service Worker registration:**

At the bottom of the initialization flow (after all module inits), add a self-contained block:

```js
// PWA: Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      console.log('[SW] Registered:', reg.scope);
    }).catch(err => {
      console.warn('[SW] Registration failed:', err);
    });
  });
}

// PWA: Offline indicator
const offlineBanner = document.getElementById('offline-banner');
function updateOnlineStatus() {
  if (offlineBanner) offlineBanner.style.display = navigator.onLine ? 'none' : 'block';
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus(); // run on load
```

**FastAPI static file mount check:** Confirm that `frontend/` is served correctly. The SW is registered at `/sw.js` — this only works if FastAPI mounts the frontend directory at the root path `/`. Check `backend/server/__init__.py` for how static files are mounted. If the frontend is mounted at `/static` rather than `/`, the SW path needs to match. Adjust the `navigator.serviceWorker.register('/sw.js')` path accordingly. Also confirm the manifest href matches the actual served path.

To verify the static serving path, run:
```bash
grep -n "StaticFiles\|mount" backend/server/__init__.py | head -20
```
Then adjust paths in index.html `href` and app.js `register()` call to match reality.
  </action>
  <verify>
Start the server: `cd "/Users/eyalatar/Desktop/try /studyflow" && source .venv/bin/activate && python backend/run.py &`
Wait 2 seconds, then:
```bash
curl -s http://localhost:8000/manifest.json | python3 -c "import sys,json; d=json.load(sys.stdin); assert d['display']=='standalone', 'manifest invalid'; print('manifest OK')"
curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/sw.js
```
Both should return valid responses. Kill server after: `pkill -f "python backend/run.py"`
  </verify>
  <done>
`/manifest.json` returns valid JSON with `display: "standalone"`. `/sw.js` returns 200. Offline banner element exists in DOM. Service worker registers in browser DevTools without errors.
  </done>
</task>

</tasks>

<verification>
1. curl http://localhost:8000/manifest.json returns JSON with `"display": "standalone"`
2. curl http://localhost:8000/sw.js returns 200 with JS content
3. Browser DevTools > Application > Manifest: shows app name, icons, display mode
4. Browser DevTools > Application > Service Workers: shows sw.js as "activated and running"
5. Offline banner (#offline-banner) appears when DevTools Network throttling set to "Offline"
</verification>

<success_criteria>
- App can be installed to home screen via browser "Add to Home Screen"
- App shell loads without network after first visit (service worker caches it)
- Offline indicator shows when device is offline
- Push event handler in SW is wired (ready for Plan 02's backend push delivery)
</success_criteria>

<output>
After completion, create `.planning/phases/11-push-notifications/11-01-SUMMARY.md`
</output>
