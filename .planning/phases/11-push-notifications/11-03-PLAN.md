---
phase: 11-push-notifications
plan: 03
type: execute
wave: 2
depends_on: [11-01, 11-02]
files_modified:
  - frontend/index.html
  - frontend/js/tasks.js
  - frontend/js/auth.js
autonomous: false
requirements: [NOTIF-01, NOTIF-02]

must_haves:
  truths:
    - "Permission modal appears after user marks their FIRST task as Done (never on initial load)"
    - "Tapping 'Yes' in the modal calls Notification.requestPermission() and registers with /push/subscribe"
    - "Tapping 'No' or dismissing does nothing â€” no retry on this session"
    - "Settings modal contains notification controls: timing dropdown and per-task/daily-summary toggles"
    - "Notification settings are saved to the server and reloaded when settings modal opens"
  artifacts:
    - path: "frontend/index.html"
      provides: "Permission onboarding modal (#modal-notif-permission) and notification settings section in #modal-settings"
      contains: "modal-notif-permission"
    - path: "frontend/js/tasks.js"
      provides: "First-task-done detection logic that shows permission modal"
      contains: "notif-permission"
    - path: "frontend/js/auth.js"
      provides: "Load/save notification preferences, subscribe() call to POST /push/subscribe"
      contains: "push/subscribe"
  key_links:
    - from: "frontend/js/tasks.js"
      to: "frontend/index.html#modal-notif-permission"
      via: "show modal after first task done"
      pattern: "modal-notif-permission.*active|hasSeenNotifPrompt"
    - from: "frontend/js/auth.js"
      to: "/push/subscribe"
      via: "fetch POST with PushSubscription JSON"
      pattern: "push/subscribe"
    - from: "frontend/js/auth.js"
      to: "/push/vapid-public-key"
      via: "fetch GET to get VAPID key for subscription creation"
      pattern: "vapid-public-key"
    - from: "frontend/js/auth.js"
      to: "#modal-settings notification controls"
      via: "load notif prefs from /users/me and populate dropdowns/toggles"
      pattern: "notif_timing|notif_per_task|notif_daily_summary"
---

<objective>
Wire the user-facing notification experience: permission onboarding modal (triggered on first task done), browser push subscription registration, and notification settings UI within the existing settings modal.

Purpose: NOTIF-01 (user receives notifications) requires the browser subscription to be registered. NOTIF-02 (user controls preferences) requires the settings UI.
Output: Updated index.html, tasks.js, auth.js
</objective>

<execution_context>
@/Users/eyalatar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-push-notifications/11-CONTEXT.md
@.planning/phases/11-push-notifications/11-01-SUMMARY.md
@.planning/phases/11-push-notifications/11-02-SUMMARY.md
@frontend/index.html
@frontend/js/tasks.js
@frontend/js/auth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Permission onboarding modal (HTML) + first-task-done trigger (tasks.js)</name>
  <files>frontend/index.html, frontend/js/tasks.js</files>
  <action>
**frontend/index.html â€” add permission modal:**

Add this modal HTML just before the closing `</body>` tag (after the existing modals):

```html
<!-- NOTIFICATION PERMISSION MODAL -->
<div id="modal-notif-permission" class="modal-bg">
  <div class="w-full max-w-sm mx-4 bg-dark-700 rounded-3xl border border-white/10 shadow-2xl p-6 text-center">
    <div class="text-4xl mb-4">ðŸ””</div>
    <h2 class="text-xl font-bold mb-2">Great job finishing that task!</h2>
    <p class="text-white/50 text-sm mb-6">Want a heads-up before your next study session? StudyFlow can send you motivational reminders.</p>
    <div class="flex flex-col gap-3">
      <button id="btn-notif-yes" class="w-full bg-accent-500 hover:bg-accent-600 font-semibold py-3 rounded-xl transition-all">Yes, remind me!</button>
      <button id="btn-notif-no" class="w-full text-white/40 hover:text-white/70 text-sm py-2 transition-all">Not now</button>
    </div>
  </div>
</div>
```

**frontend/js/tasks.js â€” first-task-done detection:**

1. Add a module-level constant to track whether the permission prompt has been shown this session (and read from localStorage to persist across refreshes):
```js
const NOTIF_PROMPT_KEY = 'sf_notif_prompt_shown';

function hasShownNotifPrompt() {
  return localStorage.getItem(NOTIF_PROMPT_KEY) === '1';
}
function markNotifPromptShown() {
  localStorage.setItem(NOTIF_PROMPT_KEY, '1');
}
```

2. In the `toggleDone` function, after the successful PATCH response (inside the `try` block after `if (!patchRes.ok) throw...`), add the following logic:
```js
// Permission onboarding: show after first ever task marked Done
if (!isDone && !hasShownNotifPrompt() && 'Notification' in window && Notification.permission === 'default') {
  const currentDoneCount = getCurrentTasks().filter(t => t.status === 'done').length
    + (getCurrentSchedule ? getCurrentSchedule().filter(b => b.completed === 1).length : 0);
  if (currentDoneCount >= 1) {
    markNotifPromptShown();
    setTimeout(() => {
      const modal = document.getElementById('modal-notif-permission');
      if (modal) modal.classList.add('active');
    }, 1500); // small delay so confetti finishes first
  }
}
```

Note: `isDone` is `false` when the task is being marked as complete (the variable name is "was it done before this action"). Check the existing logic to confirm: if `isDone = false` means "it was NOT done, so we ARE marking it done now" â€” that is the correct direction for confetti spawn (`if (!isDone) spawnConfetti(btn)` confirms this).

3. In `initTasks()`, add event bindings for the permission modal buttons:
```js
// Notification permission modal
const btnNotifYes = document.getElementById('btn-notif-yes');
if (btnNotifYes) btnNotifYes.onclick = async () => {
  document.getElementById('modal-notif-permission')?.classList.remove('active');
  // Delegate to auth.js for the actual permission + subscription flow
  window.dispatchEvent(new CustomEvent('request-push-permission'));
};

const btnNotifNo = document.getElementById('btn-notif-no');
if (btnNotifNo) btnNotifNo.onclick = () => {
  document.getElementById('modal-notif-permission')?.classList.remove('active');
};
```
  </action>
  <verify>
Open browser to app. Mark any task as Done. Verify:
1. Confetti fires and task marks done.
2. After ~1.5 seconds, the permission modal appears with the "Great job!" heading.
3. Clicking "Not now" closes the modal.
4. localStorage has 'sf_notif_prompt_shown' = '1' after closing.
5. Refreshing and marking another task done does NOT show the modal again.
  </verify>
  <done>
Permission modal exists in DOM. After first task is marked done (and Notification.permission === 'default'), modal appears once after confetti. "Not now" closes it. Modal never shows again for the session (localStorage persists the flag).
  </done>
</task>

<task type="auto">
  <name>Task 2: Push subscription flow (auth.js) + Notification settings UI</name>
  <files>frontend/js/auth.js, frontend/index.html</files>
  <action>
**frontend/js/auth.js â€” add subscription and settings functions:**

1. Add a `subscribeToPush()` async function:
```js
async function subscribeToPush() {
  try {
    const API = getAPI();
    // Get VAPID public key
    const keyRes = await authFetch(`${API}/push/vapid-public-key`);
    if (!keyRes.ok) { console.warn('[Push] VAPID key not available'); return; }
    const { key } = await keyRes.json();

    // Request browser permission
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.log('[Push] Permission denied or dismissed');
      return;
    }

    // Subscribe via Service Worker
    const reg = await navigator.serviceWorker.ready;
    const subscription = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: _urlBase64ToUint8Array(key)
    });

    // Send to backend
    await authFetch(`${API}/push/subscribe`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subscription: subscription.toJSON() })
    });
    console.log('[Push] Subscribed successfully');
  } catch (e) {
    console.warn('[Push] Subscription failed:', e);
  }
}

function _urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
}
```

2. In the module initialization or `initAuth()` (whichever handles event listeners), add:
```js
window.addEventListener('request-push-permission', subscribeToPush);
```

3. In the `handleSaveSettings` function (where PATCH /users/me is called), include notification preference fields in the PATCH body:
```js
notif_timing: document.getElementById('settings-notif-timing')?.value || 'at_start',
notif_per_task: document.getElementById('settings-notif-per-task')?.checked ? 1 : 0,
notif_daily_summary: document.getElementById('settings-notif-daily-summary')?.checked ? 1 : 0,
```

4. In the profile load function (where settings modal is populated from `GET /users/me`), also populate notification fields:
```js
const notifTiming = document.getElementById('settings-notif-timing');
if (notifTiming) notifTiming.value = profile.notif_timing || 'at_start';
const notifPerTask = document.getElementById('settings-notif-per-task');
if (notifPerTask) notifPerTask.checked = (profile.notif_per_task ?? 1) === 1;
const notifDailySummary = document.getElementById('settings-notif-daily-summary');
if (notifDailySummary) notifDailySummary.checked = (profile.notif_daily_summary ?? 0) === 1;
```

**frontend/index.html â€” add notification settings section to Settings modal:**

Inside `#modal-settings`, after the existing "Peak Productivity" `<div>` block and before the closing `</div>` of the `<div class="space-y-4">`, add:

```html
<div class="border-t border-white/10 pt-4">
  <label class="text-sm text-white/50 mb-3 block font-medium">Notifications</label>
  <div class="space-y-3">
    <div>
      <label class="text-sm text-white/50 mb-1 block">Notify me</label>
      <select id="settings-notif-timing" class="input-field appearance-none">
        <option value="at_start">At start time</option>
        <option value="15_before">15 mins before</option>
        <option value="30_before">30 mins before</option>
      </select>
    </div>
    <div class="flex items-center justify-between">
      <span class="text-sm text-white/60">Notify for every task</span>
      <input id="settings-notif-per-task" type="checkbox" class="w-4 h-4 accent-indigo-500" checked>
    </div>
    <div class="flex items-center justify-between">
      <span class="text-sm text-white/60">Daily morning summary</span>
      <input id="settings-notif-daily-summary" type="checkbox" class="w-4 h-4 accent-indigo-500">
    </div>
  </div>
</div>
```
  </action>
  <verify>
1. Start server and open app in browser.
2. Open Settings modal â€” verify notification section appears with timing dropdown and two checkboxes.
3. Change timing to "15 mins before", save â€” verify PATCH /users/me includes notif_timing.
4. Reopen settings â€” verify notif_timing value is restored to "15 mins before".
5. On a fresh browser (no prior permission prompt), mark a task done â†’ wait 1.5s â†’ click "Yes, remind me!" â†’ confirm browser permission dialog appears.
6. Check browser DevTools > Application > Push Messaging â€” confirm subscription registered.
7. Check server logs for subscription stored (no errors on POST /push/subscribe).
  </verify>
  <done>
Notification settings section visible in Settings modal. Preferences persist on save and reload. Permission modal â†’ "Yes" â†’ browser asks for permission â†’ if granted, POST /push/subscribe succeeds and subscription stored in DB. "No" gracefully dismisses without error.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify complete Phase 11 Push Notifications</name>
  <action>Human verification of all Phase 11 features across Plans 01, 02, and 03.</action>
  <what-built>
Complete Phase 11 Push Notifications implementation:
- Plan 01: PWA manifest + service worker (offline caching, push event handler, offline banner)
- Plan 02: VAPID backend, /push/subscribe endpoint, APScheduler cron with Claude WhatsApp-friend messages
- Plan 03: Permission onboarding modal (first-task-done trigger), notification settings UI

All three plans must be executed before this checkpoint.
  </what-built>
  <how-to-verify>
1. **PWA Install:** Open app in Chrome/Edge, look for install icon in address bar or three-dot menu â†’ "Install StudyFlow". On mobile, look for "Add to Home Screen" banner. Confirm app opens in standalone mode (no browser chrome).

2. **Offline Mode:** In browser DevTools â†’ Network â†’ set to "Offline". Refresh app. Confirm:
   - Offline banner appears at top ("You are offline â€” schedule is read-only")
   - App shell (HTML/CSS) loads from cache
   - API calls fail gracefully (not a blank screen crash)

3. **Permission Onboarding:** Mark any task as Done for the first time (clear localStorage key 'sf_notif_prompt_shown' if needed). Verify:
   - Confetti fires
   - After ~1.5s, "Great job!" modal appears
   - "Not now" closes it without error
   - "Yes, remind me!" triggers browser permission dialog

4. **Notification Settings:** Open Settings modal. Verify notification section is visible with:
   - "Notify me" dropdown (At start time / 15 mins before / 30 mins before)
   - "Notify for every task" checkbox (checked by default)
   - "Daily morning summary" checkbox (unchecked by default)
   - Save â†’ close â†’ reopen: settings are preserved

5. **Server Health:** Check server terminal for:
   - "[Scheduler] Push notification scheduler started" on boot
   - No crash errors during normal use
  </how-to-verify>
  <verify>Human confirms all 5 checks above pass.</verify>
  <done>User types "approved" after verifying PWA install, offline mode, permission flow, notification settings, and server health.</done>
  <resume-signal>Type "approved" if all checks pass, or describe which checks failed and what you observed</resume-signal>
</task>

</tasks>

<verification>
1. `/manifest.json` returns valid JSON with display:standalone
2. `/sw.js` returns 200 with Service Worker code
3. Permission modal appears after first task done (not on load)
4. Notification settings section exists in settings modal and persists on save
5. POST /push/subscribe stores subscription in users.push_subscription column
6. Server starts cleanly with scheduler logged
7. App installable via browser "Add to Home Screen"
8. Offline banner appears when network is disabled
</verification>

<success_criteria>
- NOTIF-01: User receives push notifications powered by Claude (WhatsApp-friend persona) for study reminders
- NOTIF-02: User can control timing offset and toggle per-task/daily-summary from settings
- INFRA-01: App is installable as PWA to home screen
- INFRA-03: App shell loads offline from service worker cache; offline indicator shown
</success_criteria>

<output>
After completion, create `.planning/phases/11-push-notifications/11-03-SUMMARY.md`
</output>
