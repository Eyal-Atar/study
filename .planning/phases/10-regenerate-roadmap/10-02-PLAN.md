---
phase: 10-regenerate-roadmap
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - frontend/index.html
  - frontend/js/brain.js
  - frontend/js/app.js
  - frontend/js/store.js
  - frontend/js/tasks.js
autonomous: true
requirements: [BRAIN-01, BRAIN-02, BRAIN-03]

must_haves:
  truths:
    - "The 'Talk to the Brain' chat panel is removed from the dashboard"
    - "A hidden 'Regenerate Schedule' command bar exists in the sidebar"
    - "The command bar becomes visible only when an exam date is changed OR study hours are updated in settings"
    - "User can type a natural-language reason and click Regenerate"
    - "After regeneration, the calendar updates immediately with the AI's delta changes"
    - "Regeneration bar hides itself again after a successful call"
  artifacts:
    - path: "frontend/index.html"
      provides: "Regenerate command bar HTML (hidden by default), brain chat section removed"
      contains: "regen-command-bar"
    - path: "frontend/js/brain.js"
      provides: "initRegenerate() function replacing initBrain()"
      contains: "initRegenerate"
    - path: "frontend/js/store.js"
      provides: "regenTriggered flag in store"
      contains: "regenTriggered"
    - path: "frontend/js/app.js"
      provides: "calls initRegenerate instead of initBrain, triggers regen bar on exam/settings change"
      contains: "initRegenerate"
  key_links:
    - from: "frontend/js/tasks.js modalToStep2 / deleteExam"
      to: "frontend/js/store.js regenTriggered"
      via: "setRegenTriggered(true) on exam date modification"
      pattern: "setRegenTriggered"
    - from: "frontend/js/brain.js sendRegenRequest"
      to: "/regenerate-delta (backend)"
      via: "authFetch POST with {reason}"
      pattern: "regenerate-delta"
    - from: "backend /regenerate-delta response"
      to: "frontend calendar re-render"
      via: "renderCalendar(data.tasks, data.schedule)"
      pattern: "renderCalendar"
---

<objective>
Replace the brain chat UI with a focused regeneration command bar that appears conditionally and calls the delta AI endpoint.

Purpose: The user decision is to remove free-form brain chat and replace it with a constraint-triggered "Regenerate Schedule" bar. The bar is hidden by default and only appears when a meaningful schedule constraint changes (exam moved, study hours changed). This keeps the UI focused and prevents frivolous regeneration calls.

Output: Updated HTML (chat removed, regen bar added), updated brain.js with regeneration logic, store tracking regen state, wiring in app.js and tasks.js.
</objective>

<execution_context>
@/Users/eyalatar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-regenerate-roadmap/10-CONTEXT.md
@frontend/index.html
@frontend/js/brain.js
@frontend/js/store.js
@frontend/js/app.js
@frontend/js/tasks.js
@.planning/phases/10-regenerate-roadmap/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace brain chat HTML with regeneration command bar</name>
  <files>
    frontend/index.html
    frontend/js/store.js
  </files>
  <action>
**frontend/index.html — remove "Talk to the Brain" chat section, add regeneration command bar:**

Find the entire "Talk to the Brain" card div in the sidebar section (it has id="brain-chat-history", id="brain-input", id="btn-brain-send", id="brain-loading"). Remove this entire card div.

In its place, insert the following HTML for the regeneration command bar. The card uses `hidden` class so it is invisible by default:

```html
<!-- Regenerate Schedule Command Bar (hidden by default, shown on constraint change) -->
<div id="regen-command-bar" class="hidden bg-dark-700/60 backdrop-blur-sm rounded-3xl p-5 border border-accent-500/30 fade-in">
    <h3 class="font-bold mb-2 flex items-center gap-2">
        <span class="w-6 h-6 rounded-lg bg-gradient-to-br from-accent-500 to-mint-500 flex items-center justify-center text-xs">↺</span>
        Schedule Changed
    </h3>
    <p class="text-white/40 text-xs mb-3" id="regen-trigger-label">A constraint changed — tell the brain what happened.</p>
    <textarea id="regen-input" rows="2"
        placeholder="e.g. I moved my Linear Algebra exam to Friday, shift everything"
        class="w-full bg-dark-900/60 border border-white/10 rounded-xl px-3 py-2 text-sm text-white placeholder-white/30 focus:outline-none focus:border-accent-500 resize-none mb-3"></textarea>
    <div class="flex gap-2">
        <button id="btn-regen-dismiss" class="px-3 py-2 rounded-xl text-xs text-white/40 hover:text-white/60 border border-white/10 hover:border-white/20 transition-all">
            Dismiss
        </button>
        <button id="btn-regen-send" class="flex-1 bg-gradient-to-r from-accent-500 to-mint-500 px-3 py-2 rounded-xl text-sm font-medium hover:opacity-90 transition-all">
            Regenerate
        </button>
    </div>
    <div id="regen-loading" class="hidden mt-2 text-xs text-accent-400">
        <span>↺</span> Brain is regenerating your schedule...
    </div>
    <div id="regen-result" class="hidden mt-2 text-xs text-mint-400"></div>
</div>
```

Place this new card at the same position where the "Talk to the Brain" card was (first card in the sidebar space-y-4 div, after "Today's Focus" if appropriate, or in the same relative position).

**frontend/js/store.js — add regenTriggered flag and trigger label:**

Add two new fields to the `store` object:
```javascript
regenTriggered: false,
regenTriggerLabel: '',
```

Add getter/setter exports at the bottom of the file:
```javascript
export const getRegenTriggered = () => store.regenTriggered;
export const setRegenTriggered = (val, label = '') => {
    store.regenTriggered = val;
    store.regenTriggerLabel = label;
};
export const getRegenTriggerLabel = () => store.regenTriggerLabel;
```

Also add `regenTriggered: false, regenTriggerLabel: ''` to the `resetStore()` function's reset block.

This flag is the single source of truth for whether the regen bar should be visible. It is set to true by tasks.js and app.js when a constraint changes, and reset to false after a successful regeneration or dismiss.
  </action>
  <verify>
    Open frontend/index.html and confirm:
    - No element with id="brain-input" exists
    - Element with id="regen-command-bar" exists with class containing "hidden"
    - Element with id="btn-regen-send" exists
    Open frontend/js/store.js and confirm:
    - `regenTriggered` field in store object
    - `setRegenTriggered` export exists
    Run: `grep -n "brain-input\|brain-chat-history\|btn-brain-send" "/Users/eyalatar/Desktop/try /studyflow/frontend/index.html"` — should return nothing (chat elements removed)
    Run: `grep -n "regen-command-bar\|btn-regen-send" "/Users/eyalatar/Desktop/try /studyflow/frontend/index.html"` — should show the new elements
  </verify>
  <done>
    - Brain chat HTML (brain-input, brain-chat-history, btn-brain-send, brain-loading) completely removed from index.html
    - Regeneration command bar (id=regen-command-bar) present in index.html with hidden class
    - store.js has regenTriggered flag, setRegenTriggered, getRegenTriggered exports
    - resetStore() resets regenTriggered to false
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace brain.js with regeneration logic, wire triggers in app.js and tasks.js</name>
  <files>
    frontend/js/brain.js
    frontend/js/app.js
    frontend/js/tasks.js
  </files>
  <action>
**frontend/js/brain.js — completely replace with regeneration module:**

Replace the entire contents of brain.js with the following regeneration module. This replaces `sendBrainMessage`, `addChatBubble`, and `initBrain` with `sendRegenRequest` and `initRegenerate`:

```javascript
import { getAPI, authFetch, setRegenTriggered, getRegenTriggerLabel, setCurrentTasks, setCurrentSchedule } from './store.js';
import { renderCalendar, renderTodayFocus } from './calendar.js';
import { updateStats } from './tasks.js';

/**
 * Show or hide the regeneration command bar.
 * Called whenever a constraint changes (exam date updated, study hours changed).
 */
export function showRegenBar(label) {
    const bar = document.getElementById('regen-command-bar');
    const triggerLabel = document.getElementById('regen-trigger-label');
    if (!bar) return;
    if (label && triggerLabel) triggerLabel.textContent = label;
    bar.classList.remove('hidden');
    // Clear previous result
    const result = document.getElementById('regen-result');
    if (result) { result.classList.add('hidden'); result.textContent = ''; }
    // Focus the textarea
    const input = document.getElementById('regen-input');
    if (input) setTimeout(() => input.focus(), 100);
}

export function hideRegenBar() {
    const bar = document.getElementById('regen-command-bar');
    if (bar) bar.classList.add('hidden');
    const input = document.getElementById('regen-input');
    if (input) input.value = '';
    setRegenTriggered(false);
}

export async function sendRegenRequest() {
    const input = document.getElementById('regen-input');
    const reason = input ? input.value.trim() : '';
    if (!reason) {
        if (input) input.classList.add('border-coral-400');
        setTimeout(() => input && input.classList.remove('border-coral-400'), 1500);
        return;
    }

    const loading = document.getElementById('regen-loading');
    const result = document.getElementById('regen-result');
    const btn = document.getElementById('btn-regen-send');
    const API = getAPI();

    if (loading) loading.classList.remove('hidden');
    if (result) { result.classList.add('hidden'); result.textContent = ''; }
    if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }

    try {
        const res = await authFetch(`${API}/regenerate-delta`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason }),
        });
        const data = await res.json();

        if (!res.ok) {
            if (result) {
                result.textContent = data.detail || 'Regeneration failed. Try again.';
                result.classList.remove('hidden');
                result.className = result.className.replace('text-mint-400', 'text-coral-400');
            }
            return;
        }

        // Update store and re-render calendar
        setCurrentTasks(data.tasks);
        setCurrentSchedule(data.schedule);
        renderCalendar(data.tasks, data.schedule);
        renderTodayFocus(data.tasks);
        updateStats();

        // Show reasoning and hide bar after short delay
        const blocksMsg = data.blocks_updated === 0
            ? 'No changes needed.'
            : `${data.blocks_updated} block${data.blocks_updated === 1 ? '' : 's'} updated.`;

        if (result) {
            result.textContent = `${data.reasoning || ''} ${blocksMsg}`;
            result.classList.remove('hidden', 'text-coral-400');
            result.classList.add('text-mint-400');
        }

        // Auto-dismiss after 3 seconds
        setTimeout(() => hideRegenBar(), 3000);

    } catch (e) {
        if (result) {
            result.textContent = 'Failed to reach the server. Check connection.';
            result.classList.remove('hidden');
        }
    } finally {
        if (loading) loading.classList.add('hidden');
        if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
    }
}

export function initRegenerate() {
    const btnSend = document.getElementById('btn-regen-send');
    if (btnSend) btnSend.onclick = sendRegenRequest;

    const btnDismiss = document.getElementById('btn-regen-dismiss');
    if (btnDismiss) btnDismiss.onclick = hideRegenBar;

    const input = document.getElementById('regen-input');
    if (input) {
        input.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendRegenRequest();
            }
        };
    }
}
```

**frontend/js/app.js — update import and wiring:**

1. Find the import line for brain.js: `import { ... } from './brain.js'` (or similar)
2. Replace the import to use new exports: `import { initRegenerate, showRegenBar } from './brain.js';`
3. Find where `initBrain()` is called and replace it with `initRegenerate();`
4. Remove any import of `addChatBubble` or `sendBrainMessage` that no longer exist.

Also add the exam date change trigger: In app.js, find the settings save handler (btn-save-settings onclick). After the successful save, if `neto_study_hours` changed, call:
```javascript
import { showRegenBar } from './brain.js';
// After successful settings save where study hours changed:
showRegenBar('Study hours changed — update the schedule if needed.');
```

Detect hours change by comparing the input value before and after save. Store the old value before the save call, compare after.

**frontend/js/tasks.js — trigger regen bar when exam date changes:**

In the `modalToStep2()` function (which creates/saves an exam), after a successful `POST /exams` response and before `setPendingExamId(exam.id)`, do NOT add anything — exam creation does not trigger regen (user will generate a new roadmap instead).

However, in the `deleteExam()` function, after the delete call succeeds, the schedule is already cleared by the backend via CASCADE. No regen trigger needed here either.

The regen trigger is specifically for when an EXISTING exam's date is changed. Currently, there is no "edit exam date" flow in the frontend. So the primary trigger point is the settings save (study hours). Leave tasks.js unchanged — the settings trigger in app.js is sufficient for this phase.

Note: If future exam-date editing is added, that flow should call `setRegenTriggered(true)` and `showRegenBar('Exam date changed — update your schedule.')`.
  </action>
  <verify>
    Check brain.js has no reference to old functions: `grep -n "sendBrainMessage\|addChatBubble\|initBrain" "/Users/eyalatar/Desktop/try /studyflow/frontend/js/brain.js"` — should return nothing
    Check brain.js has new functions: `grep -n "initRegenerate\|sendRegenRequest\|showRegenBar" "/Users/eyalatar/Desktop/try /studyflow/frontend/js/brain.js"` — should show all three
    Check app.js uses initRegenerate: `grep -n "initRegenerate\|initBrain" "/Users/eyalatar/Desktop/try /studyflow/frontend/js/app.js"` — should show initRegenerate, no initBrain
    Open the app in browser and confirm:
    - No chat panel visible in sidebar
    - Regen bar hidden by default
    - Changing study hours in settings reveals the regen bar
  </verify>
  <done>
    - brain.js contains only initRegenerate, showRegenBar, hideRegenBar, sendRegenRequest (no chat functions)
    - app.js imports initRegenerate (not initBrain) and calls it on dashboard init
    - Changing study hours in settings reveals the regen command bar with appropriate label
    - Regen bar hidden by default on fresh load
    - Regen call POSTs to /regenerate-delta and re-renders calendar with returned schedule
    - Bar auto-dismisses after successful regeneration
  </done>
</task>

</tasks>

<verification>
1. Open the app and log in — the sidebar should NOT have a "Talk to Brain" chat panel.
2. The sidebar SHOULD show "Today's Focus" and "Exam Colors" cards with no chat input visible.
3. The regenerate command bar (id=regen-command-bar) should have class "hidden".
4. Go to Settings, change the "Neto study hours" slider, save — the regen command bar should appear.
5. Type a reason like "I added more study material" and click Regenerate — the calendar should update after the AI call.
6. Confirm the bar dismisses itself after 3 seconds following a successful call.
7. `grep -rn "brain-input\|btn-brain-send\|brain-chat-history" frontend/` should return nothing.
</verification>

<success_criteria>
- "Talk to Brain" chat panel completely removed from UI
- Regeneration command bar hidden by default
- Bar appears when study hours setting changes
- Typing a reason and clicking Regenerate calls POST /regenerate-delta
- Calendar re-renders with updated schedule after success
- Bar shows AI reasoning text and auto-dismisses after 3 seconds
- No JS console errors on page load
</success_criteria>

<output>
After completion, create `.planning/phases/10-regenerate-roadmap/10-02-SUMMARY.md`
</output>
