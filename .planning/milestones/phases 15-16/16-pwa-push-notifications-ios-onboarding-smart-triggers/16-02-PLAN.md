---
phase: 16-pwa-push-notifications-ios-onboarding-smart-triggers
plan: 02
type: fix
autonomous: true
requirements: [NOTIF-01, NOTIF-02]
---

<objective>
Fix notification VAPID mismatch, consolidate storage, and ensure robust error handling for push subscriptions.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Update push sending logic to handle subscription removal</name>
  <files>backend/notifications/utils.py</files>
  <action>
    Update `backend/notifications/utils.py`: Ensure `send_to_user` deletes subscriptions from `push_subscriptions` table when receiving 403 (Forbidden) or 410 (Gone).
  </action>
  <verify>
    Check code for handling 403 and 410 status codes in the push sending loop and deleting from the database.
  </verify>
</task>

<task type="auto">
  <name>Task 2: Consolidate storage and use standard VAPID config</name>
  <files>backend/notifications/routes.py</files>
  <action>
    Update `backend/notifications/routes.py`:
    - Unify storage: Only use `push_subscriptions` table. Stop updating/reading the `users.push_subscription` column.
    - Use standard `server.config` for VAPID keys instead of direct `os.getenv`.
  </action>
  <verify>
    Verify `users.push_subscription` is no longer used and VAPID keys are pulled from `config.VAPID_PUBLIC_KEY` and `config.VAPID_PRIVATE_KEY`.
  </verify>
</task>

<task type="auto">
  <name>Task 3: Update scheduler to query only push_subscriptions</name>
  <files>backend/notifications/scheduler.py</files>
  <action>
    Update `backend/notifications/scheduler.py`: Ensure it queries only the `push_subscriptions` table.
  </action>
  <verify>
    Check that the scheduler joins or queries `push_subscriptions` instead of relying on the legacy `users.push_subscription` field.
  </verify>
</task>

<task type="auto">
  <name>Task 4: Verify frontend VAPID key matching</name>
  <files>frontend/js/notifications.js</files>
  <action>
    Verify `frontend/js/notifications.js`: Confirm `checkVapidKeyMatch` is active and correctly triggers `subscribeToPush` on mismatch.
  </action>
  <verify>
    Ensure `checkVapidKeyMatch` is called during initialization or subscription check.
  </verify>
</task>

<task type="auto">
  <name>Task 5: Verification and cache refresh</name>
  <files>frontend/js/app.js</files>
  <action>
    1. Verification: Add a task for 1 min from now, refresh app, and check logs for successful push attempt (or lack of 403).
    2. Touch `frontend/js/app.js` to refresh hash (add a comment or minor change).
  </action>
  <verify>
    Logs show push attempts and `app.js` has a fresh timestamp/hash.
  </verify>
</task>

</tasks>
