---
phase: 16-pwa-push-notifications-ios-onboarding-smart-triggers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/server/database.py, scripts/generate_vapid.py, backend/notifications/routes.py, backend/notifications/scheduler.py, backend/notifications/utils.py, frontend/sw.js, frontend/js/ui.js, frontend/js/notifications.js, frontend/js/app.js]
autonomous: true
requirements: [NOTIF-01, NOTIF-02, INFRA-01, INFRA-03]

must_haves:
  truths:
    - "iOS users see 'Add to Home Screen' guide when not in standalone mode"
    - "Push subscriptions are stored in a dedicated multi-device table"
    - "Notifications trigger 2 minutes before task start"
    - "Tapping a notification deep-links to the specific task and scrolls to it"
    - "Foreground notifications are shown as in-app toasts, not system banners"
  artifacts:
    - path: "backend/notifications/utils.py"
      provides: "Unified push sending logic with VAPID"
    - path: "scripts/generate_vapid.py"
      provides: "Utility to generate VAPID keys"
    - path: "frontend/js/ui.js"
      provides: "iOS onboarding overlay"
  key_links:
    - from: "backend/brain/routes.py"
      to: "backend/notifications/utils.py"
      via: "call to send_to_user on roadmap generation"
    - from: "frontend/sw.js"
      to: "frontend/js/app.js"
      via: "postMessage for SCROLL_TO_BLOCK"
---

<objective>
Implement a robust PWA push notification system with multi-device support, iOS onboarding, and smart triggers.

Purpose: Bridge the communication gap between server and device, providing native-app engagement.
Output: Fully functional VAPID push system with smart timing and deep-linking.
</objective>

<execution_context>
@/Users/eyalatar/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/16-pwa-push-notifications-ios-onboarding-smart-triggers/CONTEXT.md
@.planning/phases/16-pwa-push-notifications-ios-onboarding-smart-triggers/RESEARCH.md
@backend/notifications/scheduler.py
@backend/notifications/routes.py
@frontend/sw.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Infrastructure & Backend Foundation</name>
  <files>backend/server/database.py, scripts/generate_vapid.py, backend/notifications/routes.py, backend/notifications/utils.py</files>
  <action>
    1. Update `backend/server/database.py` to create `push_subscriptions` table: `id, user_id, endpoint UNIQUE, p256dh, auth, device_name, created_at`.
    2. Create `scripts/generate_vapid.py` using `pywebpush` to output VAPID keys.
    3. Create `backend/notifications/utils.py` containing `send_to_user(db, user_id, title, body, url, block_id)` helper that handles multiple subscriptions and removes expired (404/410) ones.
    4. Refactor `backend/notifications/routes.py`:
       - `POST /push/subscribe`: Upsert into `push_subscriptions` table.
       - `DELETE /push/subscribe`: Delete from `push_subscriptions` where endpoint matches (client should send endpoint).
       - Ensure standard VAPID key loading from env vars.
  </action>
  <verify>
    - `python3 scripts/generate_vapid.py` works.
    - DB migration creates table (check with `sqlite3 studyflow.db ".schema push_subscriptions"`).
    - Subscribing from a test client (or curl) persists to the new table.
  </verify>
  <done>Multi-device push foundation is ready on the backend.</done>
</task>

<task type="auto">
  <name>Task 2: Smart Triggers & Logic</name>
  <files>backend/notifications/scheduler.py, backend/brain/routes.py</files>
  <action>
    1. Refactor `backend/notifications/scheduler.py`:
       - Update `_check_and_send_notifications` to query `push_subscriptions` table.
       - Add `2_before` to `TIMING_OFFSETS` (and ensure it's used or hardcoded if requested).
       - Ensure `send_to_user` from `utils.py` is used.
       - Include `block_id` and `url` in push payload for deep linking.
    2. Update `backend/brain/routes.py`:
       - In `generate_roadmap` and `brain_chat`, after saving the schedule, call `send_to_user` to notify "Roadmap is ready! ðŸš€".
  </action>
  <verify>
    - Scheduler runs and logs attempts.
    - Roadmap generation triggers a push send (check logs).
  </verify>
  <done>Smart triggers are active and payloads contain deep-linking data.</done>
</task>

<task type="auto">
  <name>Task 3: Frontend & Service Worker</name>
  <files>frontend/sw.js, frontend/js/ui.js, frontend/js/notifications.js, frontend/js/app.js</files>
  <action>
    1. Update `frontend/js/ui.js`: Add `showIosOnboarding()` which detects iOS + non-standalone mode and shows a "Share > Add to Home Screen" overlay.
    2. Create/Update `frontend/js/notifications.js`:
       - Handle push subscription registration.
       - Listen for `postMessage` from SW to show foreground toasts/visual cues.
       - `showToast(title, body, blockId)` logic.
    3. Update `frontend/sw.js`:
       - In `push` event: Check if any client is focused (`client.visibilityState === 'visible'`). If yes, use `postMessage` instead of `showNotification`.
       - In `notificationclick` event: Focus client AND send `SCROLL_TO_BLOCK` message if `blockId` exists.
    4. Update `frontend/js/app.js` or `calendar.js`:
       - Add listener for `SCROLL_TO_BLOCK` message.
       - Implement auto-scroll to the specific task card by ID.
  </action>
  <verify>
    - iOS overlay appears on mobile Safari (simulate UA if needed).
    - SW handles push events correctly.
    - App scrolls to task when receiving deep-link signal.
  </verify>
  <done>User experience for push notifications and onboarding is complete.</done>
</task>

</tasks>

<verification>
1. Generate VAPID keys and add to .env.
2. Run server and visit on a mobile device (or simulated).
3. Verify iOS onboarding overlay if applicable.
4. Subscribe to notifications.
5. Trigger a roadmap generation and verify "Ready" notification.
6. Set a task to start in 2 minutes and verify push notification.
7. Click notification (app closed) and verify it opens + scrolls to task.
8. Have app open (foreground) and verify toast appears instead of system banner.
</verification>

<success_criteria>
- End-to-end push notification flow works (Subscribe -> Trigger -> Receive -> Deep Link).
- iOS users are guided to install the app.
- Multi-device support prevents token loss on new login.
- Foreground app suppresses noisy system banners.
</success_criteria>

<output>
After completion, create `.planning/phases/16-pwa-push-notifications-ios-onboarding-smart-triggers/16-01-SUMMARY.md`
</output>
