---
phase: 15-task-checkbox-sync-exam-progress-bars-and-push-to-next-day-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/server/database.py
  - backend/tasks/routes.py
  - frontend/js/tasks.js
  - frontend/js/calendar.js
autonomous: true
requirements: []

must_haves:
  truths:
    - "Marking a schedule block done/undone syncs parent task status so exam progress bars stay correct"
    - "Exam progress (done_count) is task-based; all blocks for a task done => task status = done"
    - "POST /tasks/block/{block_id}/defer moves block to next calendar day (push-to-next-day foundation)"
    - "Frontend refreshes schedule and exam cards after defer so calendar and progress bars update"
  artifacts:
    - path: backend/server/database.py
      provides: optional deferred_original_day column for schedule_blocks (foundation)
      contains: deferred_original_day
    - path: backend/tasks/routes.py
      provides: block↔task sync on done/undone; POST defer endpoint
      contains: mark_block_done|mark_block_undone|defer
    - path: frontend/js/tasks.js
      provides: optional defer action / refresh after defer
    - path: frontend/js/calendar.js
      provides: Defer to tomorrow button or handler on block
  key_links:
    - from: frontend toggleDone
      to: backend PATCH block done/undone
      via: authFetch
    - from: backend mark_block_done
      to: tasks table
      via: sync task status when all blocks for task are done
---

<objective>
Implement task checkbox sync (block completed ↔ task status), keep exam progress bars accurate, and add push-to-next-day foundation (Defer API + optional frontend trigger).

Purpose: When a user marks a schedule block done/undone, the parent task status must stay in sync so GET /exams returns correct done_count and progress bars update. Add defer endpoint to move a block to the next day as foundation for "push to tomorrow" UX.

Output: DB migration (optional column), backend sync in mark_block_done/undone, POST /tasks/block/{id}/defer, frontend refresh after defer and optional defer button.
</objective>

<context>
@.planning/ROADMAP.md (Phase 15)
@backend/server/database.py
@backend/tasks/routes.py
@backend/exams/routes.py
@frontend/js/tasks.js
@frontend/js/calendar.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Block↔Task sync on mark block done/undone</name>
  <files>
    backend/tasks/routes.py
  </files>
  <action>
In mark_block_done: after UPDATE schedule_blocks SET completed = 1, fetch the block's task_id. If task_id is not null, count blocks for that task: SELECT COUNT(*), SUM(completed) FROM schedule_blocks WHERE task_id = ? AND user_id = ?. If SUM(completed) equals COUNT(*) (all blocks done), run UPDATE tasks SET status = 'done' WHERE id = ? AND user_id = ?. Commit and close.

In mark_block_undone: after UPDATE schedule_blocks SET completed = 0, if the block has task_id, run UPDATE tasks SET status = 'pending' WHERE id = ? AND user_id = ? (any block undone => task no longer fully done). Commit and close.
  </action>
  <verify>
    Start backend: cd backend && python -m uvicorn server:app --port 8001 2>&1 &amp; sleep 2
    curl -s -X PATCH http://localhost:8001/tasks/block/1/done -H "Authorization: Bearer &lt;token&gt;" (or use existing auth). Check DB: task status for that block's task_id is 'done' when all blocks for task are completed.
    Stop server: pkill -f "port 8001" 2>/dev/null || true
  </verify>
  <done>
    - mark_block_done sets task status = done when all blocks for that task are completed
    - mark_block_undone sets task status = pending for that task
    - No new syntax errors; server starts
  </done>
</task>

<task type="auto">
  <name>Task 2: DB migration deferred_original_day (optional) and POST /tasks/block/{id}/defer</name>
  <files>
    backend/server/database.py
    backend/tasks/routes.py
  </files>
  <action>
**database.py:** In block_columns migrations, add: if "deferred_original_day" not in block_columns: conn.execute("ALTER TABLE schedule_blocks ADD COLUMN deferred_original_day TEXT"). This stores the original day_date when block was deferred for future UI (e.g. "Moved from 2025-01-15").

**tasks/routes.py:** Add POST /tasks/block/{block_id}/defer. Logic: get block by id and user_id. If not found return 404. Parse block.day_date and block start_time/end_time. Compute next_day = day_date + 1 day (use datetime.strptime and timedelta). Build new start_time/end_time for next_day (same clock time). UPDATE schedule_blocks SET start_time = ?, end_time = ?, day_date = ?, is_delayed = 1, deferred_original_day = ? WHERE id = ? AND user_id = ? (deferred_original_day = current block day_date before update). If block has task_id, UPDATE tasks SET day_date = ?, is_delayed = 1 WHERE id = ? AND user_id = ? (day_date = next_day). Return {"message": "Block deferred to next day", "day_date": next_day}.
  </action>
  <verify>
    Start server, POST to /tasks/block/1/defer with auth. Check schedule_blocks row: day_date is next day, is_delayed=1, deferred_original_day set. Task day_date updated if task_id present.
    Stop server.
  </verify>
  <done>
    - schedule_blocks has deferred_original_day column (migration)
    - POST /tasks/block/{block_id}/defer moves block to next day and sets is_delayed and deferred_original_day
    - Associated task day_date and is_delayed updated
  </done>
</task>

<task type="auto">
  <name>Task 3: Frontend — refresh schedule after defer; optional Defer button on block</name>
  <files>
    frontend/js/calendar.js
    frontend/js/tasks.js
  </files>
  <action>
Add a way to trigger defer and refresh: (1) In calendar.js, when rendering a schedule block, add a small "Defer" or "→ Tomorrow" button (or context action) that calls a new function deferBlockToTomorrow(blockId). (2) In tasks.js (or calendar.js) implement deferBlockToTomorrow: authFetch POST API/tasks/block/${blockId}/defer. On success: fetch GET API/schedule and GET API/exams, setCurrentSchedule(schedule), setCurrentExams(exams), then dispatch calendar-needs-refresh or call renderCalendar(getCurrentTasks(), schedule). Ensure getCurrentTasks is still in sync (may need GET regenerate-schedule to get tasks+schedule). Prefer calling loadExams() or the same flow used after toggleDone (refresh exams + schedule) so calendar and progress bars re-render.
  </action>
  <verify>
    Load app, open calendar with blocks. Click Defer on a block; block moves to next day in UI, exam cards and progress bars still correct.
  </verify>
  <done>
    - Defer action available on block (button or context)
    - After defer, schedule and calendar refresh; exam progress bars remain correct
  </done>
</task>
</tasks>

<verification>
- Mark block done → exam progress bar increases (task synced to done when all blocks done).
- Mark block undone → progress bar decreases.
- Defer block → block appears next day; schedule and UI refresh.
</verification>

<success_criteria>
- Block done/undone syncs task status; exam done_count and progress bars reflect block completion.
- POST /tasks/block/{id}/defer exists and moves block to next day with is_delayed and deferred_original_day.
- Frontend can defer a block and see calendar update.
</success_criteria>
