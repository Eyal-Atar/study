---
phase: 08-hourly-scheduling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/server/database.py, backend/brain/schemas.py, backend/brain/routes.py]
autonomous: true
requirements: [SCHED-01, SCHED-02]

must_haves:
  truths:
    - "Database supports tracking delayed tasks"
    - "Incomplete tasks from the past are automatically moved to today's schedule pool"
  artifacts:
    - path: "backend/server/database.py"
      provides: "is_delayed column in tasks and schedule_blocks"
    - path: "backend/brain/routes.py"
      provides: "Rollover logic implementation"
  key_links:
    - from: "backend/brain/routes.py"
      to: "tasks table"
      via: "UPDATE query for rollover"
---

<objective>
Update the data model and implement rollover logic for incomplete tasks.

Purpose: To ensure that any tasks not completed in the past are automatically carried forward into today's schedule, and to provide the infrastructure for tracking "Delayed" status.
Output: Updated database schema and backend route logic for task rollover.
</objective>

<execution_context>
@/Users/eyalatar/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-hourly-scheduling/08-CONTEXT.md
@.planning/phases/08-hourly-scheduling/08-RESEARCH.md
@backend/server/database.py
@backend/brain/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Database Schema</name>
  <files>backend/server/database.py, backend/brain/schemas.py</files>
  <action>
    - Update `backend/server/database.py` to add `is_delayed INTEGER DEFAULT 0` to both `tasks` and `schedule_blocks` tables.
    - Add migrations in `init_db()` to ensure these columns exist in existing databases.
    - Update `backend/brain/schemas.py` to add `is_delayed: bool = False` to the `ScheduleBlock` Pydantic model.
  </action>
  <verify>
    Run a python script to check table info: `sqlite3 studyflow.db "PRAGMA table_info(tasks); PRAGMA table_info(schedule_blocks);"` and verify `is_delayed` is present.
  </verify>
  <done>[x] Database schema and Pydantic model support the `is_delayed` field.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Task Rollover Logic</name>
  <files>backend/brain/routes.py</files>
  <action>
    - Modify `generate_roadmap` and `brain_chat` endpoints in `backend/brain/routes.py`.
    - Before calling the scheduler, implement logic to:
        1. Determine "Today" in the user's local time using `timezone_offset`.
        2. Identify tasks with `status != 'done'` where `day_date < today`.
        3. Update these tasks' `day_date` to `today` in the database.
        4. Ensure these "rolled over" tasks are included in the list passed to `generate_multi_exam_schedule`.
    - Note: In `generate_roadmap`, make sure not to delete "done" tasks if they are relevant to the exams being processed. Actually, the requirement says "Incomplete tasks from previous days must automatically roll over".
  </action>
  <verify>
    - Manually insert an incomplete task with yesterday's date in the DB.
    - Trigger `generate-roadmap` or a `brain-chat` update.
    - Verify the task's `day_date` is updated to today.
  </verify>
  <done>[x] Incomplete tasks from the past are correctly moved to today's date before scheduling.</done>
</task>

</tasks>

<verification>
- Check database columns.
- Test rollover logic with a mock past task.
</verification>

<success_criteria>
- `is_delayed` exists in DB.
- Rollover logic successfully moves past incomplete tasks to today.
</success_criteria>

<output>
After completion, create `.planning/phases/08-hourly-scheduling/08-01-SUMMARY.md`
</output>
