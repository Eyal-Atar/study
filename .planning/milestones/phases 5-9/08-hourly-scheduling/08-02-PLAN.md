---
phase: 08-hourly-scheduling
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified: [backend/brain/scheduler.py, backend/brain/routes.py]
autonomous: true
requirements: [SCHED-01, SCHED-02]

must_haves:
  truths:
    - "Scheduler uses a strict Deadline-First approach"
    - "If daily study cap is exceeded, tasks are pushed to next day and marked as delayed"
    - "All times are stored as UTC ISO 8601 'Z' strings"
  artifacts:
    - path: "backend/brain/scheduler.py"
      provides: "Deadline-First allocation and overflow handling"
  key_links:
    - from: "backend/brain/scheduler.py"
      to: "ScheduleBlock.is_delayed"
      via: "Setting field in allocation loop"
---

<objective>
Refactor the scheduler to implement strict Deadline-First logic and handle overflow by marking tasks as delayed.

Purpose: To ensure the AI prioritizes upcoming deadlines when available study time is limited, providing a realistic and reliable study plan.
Output: Updated scheduler algorithm that correctly allocates blocks and tracks delays.
</objective>

<execution_context>
@/Users/eyalatar/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-hourly-scheduling/08-CONTEXT.md
@.planning/phases/08-hourly-scheduling/08-RESEARCH.md
@.planning/phases/08-hourly-scheduling/08-01-SUMMARY.md
@backend/brain/scheduler.py
@backend/brain/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Deadline-First Overflow Strategy</name>
  <files>backend/brain/scheduler.py</files>
  <action>
    - Refactor `generate_multi_exam_schedule()` in `backend/brain/scheduler.py`.
    - Key changes:
        1. Replace weighted proportions with strict **Deadline-First** logic.
        2. Sort active exams by `exam_date` (ascending).
        3. Iterate through days. For each day:
           - Identify "eligible" tasks for today (tasks whose `day_date` <= current day).
           - Sort eligible tasks by their exam deadline.
           - Allocate these tasks into today's available hourly blocks until `neto_study_hours` is reached or the day's study window (wake/sleep) ends.
           - **Overflow Handling**: If a task cannot fit in today's window, it is marked as `is_delayed = 1` and its effective date is pushed to the *next day's* eligibility list.
    - Ensure `hobby` and `break` blocks are still correctly positioned according to `peak_productivity` and `study_method`.
  </action>
  <verify>
    Create a test case with two exams: Exam A (due in 2 days) and Exam B (due in 5 days), where total study time needed today exceeds `neto_study_hours`. Verify Exam A tasks are scheduled first, and Exam B tasks are pushed to the next day and marked as `is_delayed`.
  </verify>
  <done>[x] Scheduler implements Deadline-First logic and correctly handles overloaded days by delaying tasks.</done>
</task>

<task type="auto">
  <name>Task 2: Robust UTC Storage & Delayed Task Persistance</name>
  <files>backend/brain/routes.py</files>
  <action>
    - Double-check all `start_time` and `end_time` generation in `scheduler.py` to ensure they are ISO 8601 strings in UTC ending with 'Z'.
    - Update `backend/brain/routes.py` to save the `is_delayed` status for both `tasks` and `schedule_blocks` after calling the scheduler.
    - Specifically, if `scheduler` marks a task as `is_delayed`, we should update that task in the `tasks` table.
  </action>
  <verify>
    - Run the scheduler and inspect the database `schedule_blocks` table.
    - Verify `start_time` format: `YYYY-MM-DDTHH:MM:SSZ`.
    - Verify `is_delayed` is correctly populated for pushed tasks in both `tasks` and `schedule_blocks` tables.
  </verify>
  <done>[x] Time storage is robustly UTC-aware, and delayed status is persisted to the database.</done>
</task>

</tasks>

<verification>
- Verify Deadline-First logic with overloaded days.
- Verify UTC storage format in SQLite.
</verification>

<success_criteria>
- Exams are prioritized by deadline.
- Overflow tasks are marked as delayed and pushed to the next day.
- UTC ISO 8601 storage is consistent.
</success_criteria>

<output>
After completion, create `.planning/phases/08-hourly-scheduling/08-02-SUMMARY.md`
</output>
