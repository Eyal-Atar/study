---
phase: 06-google-oauth-security
plan: 04
type: execute
wave: 4
depends_on: [06-03]
files_modified: []
autonomous: false
requirements: [AUTH-01, AUTH-02]
---

<objective>
Comprehensive end-to-end verification of Google OAuth, security hardening (HttpOnly cookies), and account linking/creation logic.

Purpose: Ensure the stability and security of the authentication system.
Output: Verified production-ready authentication.
</objective>

<execution_context>
@/Users/eyalatar/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/06-google-oauth-research.md
@.planning/phases/06-google-oauth-security/06-01-SUMMARY.md
@.planning/phases/06-google-oauth-security/06-02-SUMMARY.md
@.planning/phases/06-google-oauth-security/06-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full Google OAuth implementation and HttpOnly cookie-based session management.</what-built>
  <how-to-verify>
    1. **Cookie/Security Test:**
       - Log in using existing email/password.
       - Verify `session_token` cookie is present in the browser (Application tab -> Cookies).
       - Verify cookie has `HttpOnly`, `Secure` (if on https), and `SameSite=Strict` flags.
       - Verify no `studyflow_token` exists in `localStorage`.
       - Verify calling `localStorage.getItem('studyflow_token')` in the console returns `null`.
    2. **Google OAuth Flow (New User):**
       - Click "Sign in with Google" on the login screen.
       - Complete the OAuth flow with a new Google account.
       - Verify redirection to the onboarding/welcome screen.
       - Verify user name and email are correctly captured from the Google profile.
    3. **Google OAuth Flow (Returning User):**
       - Log out and log back in with the same Google account.
       - Verify direct redirection to the dashboard (no onboarding).
    4. **Account Linking:**
       - Create an account with email/password (e.g., `user@gmail.com`).
       - Log out and click "Sign in with Google" using the same Google account.
       - Verify the account is correctly linked (existing data should be available).
       - Try logging in again using the original email/password.
       - Verify it returns a 403 error (password login disabled for linked accounts).
    5. **Session & Logout:**
       - Click "Logout" and verify the `session_token` cookie is cleared.
       - Verify access to `/dashboard` is denied after logout.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues.</resume-signal>
</task>

</tasks>

<verification>
- Perform the steps listed in the checkpoint.
- Check browser console for any errors during the OAuth flow.
- Verify backend logs show successful token exchanges and account linking.
</verification>

<success_criteria>
- All authentication flows (email/password, new Google user, linked Google user) work perfectly.
- Security hardening (HttpOnly, CSRF protection) is confirmed.
- User experience follows all locked decisions from the project context.
</success_criteria>

<output>
After completion, create `.planning/phases/06-google-oauth-security/06-04-SUMMARY.md`
</output>
