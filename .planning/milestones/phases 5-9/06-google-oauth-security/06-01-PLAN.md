---
phase: 06-google-oauth-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/server/database.py, backend/server/__init__.py, backend/auth/utils.py, backend/auth/routes.py, backend/requirements.txt]
autonomous: true
requirements: [AUTH-02]
---

<objective>
Migrate the authentication system from header-based Bearer tokens to HttpOnly cookie-based sessions and prepare the database for Google OAuth.

Purpose: Secure session management and foundation for OAuth.
Output: Working cookie-based authentication for existing email/password login.
</objective>

<execution_context>
@/Users/eyalatar/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/06-google-oauth-research.md
@backend/auth/routes.py
@backend/auth/utils.py
@backend/server/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database Migration & Dependencies</name>
  <files>backend/server/database.py, backend/requirements.txt</files>
  <action>
    - Add `google_id` (TEXT, unique) and `google_linked` (BOOLEAN, default 0) columns to the `users` table in `backend/server/database.py`.
    - Add `authlib==1.6.8` and `itsdangerous` (required by Starlette SessionMiddleware) to `backend/requirements.txt`.
    - Ensure `init_db` handles the new columns gracefully (check if they exist before adding).
  </action>
  <verify>Run `python3 backend/run.py` and check the `users` table schema in SQLite.</verify>
  <done>Database schema updated and dependencies added.</done>
</task>

<task type="auto">
  <name>Task 2: Add SessionMiddleware</name>
  <files>backend/server/__init__.py</files>
  <action>
    - Import `SessionMiddleware` from `starlette.middleware.sessions`.
    - Register the middleware with the FastAPI app.
    - Use `SESSION_SECRET_KEY` from environment variables.
    - Configure `max_age=3600` for the temporary OAuth session (1 hour).
    - Set `https_only` based on the environment (False for development).
  </action>
  <verify>The app starts without errors.</verify>
  <done>SessionMiddleware is active.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Cookie-based Authentication</name>
  <files>backend/auth/utils.py, backend/auth/routes.py</files>
  <action>
    - Update `get_current_user` in `backend/auth/utils.py` to read `session_token` from a cookie named `session_token` instead of the `Authorization` header.
    - Update `register` and `login` in `backend/auth/routes.py` to:
      - Remove the `token` from the JSON response.
      - Set the `session_token` cookie in the `Response` object with `httponly=True`, `secure=True` (if prod), `samesite="strict"`, and `max_age=2592000` (30 days).
    - Update `logout` in `backend/auth/routes.py` to clear the `session_token` cookie by setting its `max_age=0`.
  </action>
  <verify>Testing with `curl` shows `Set-Cookie` header in login/register responses and successful auth using that cookie in `/auth/me`.</verify>
  <done>Authentication now uses HttpOnly cookies.</done>
</task>

</tasks>

<verification>
- Verify `users` table has `google_id` and `google_linked` columns.
- Verify `POST /auth/login` returns a `Set-Cookie` header for `session_token`.
- Verify `GET /auth/me` works when providing the cookie (simulated via curl).
- Verify `POST /auth/logout` clears the cookie.
</verification>

<success_criteria>
- Existing email/password login flow works correctly using HttpOnly cookies.
- No Bearer tokens are required in request headers for authenticated routes.
- Database is ready for OAuth identity storage.
</success_criteria>

<output>
After completion, create `.planning/phases/06-google-oauth-security/06-01-SUMMARY.md`
</output>
