---
phase: 09-interactive-task-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [frontend/js/interactions.js, frontend/css/styles.css, frontend/js/calendar.js]
autonomous: true
requirements: [SCHED-03]

must_haves:
  truths:
    - "Dragging a task block moves subsequent blocks down in real-time (Push Physics)"
    - "Pushing a task past 23:59 marks it as 'Delayed' without squashing duration"
    - "Dragged block shows visual 'lifting' effect (scale + shadow)"
  artifacts:
    - path: "frontend/js/interactions.js"
      provides: "resolveCollisions function"
    - path: "frontend/css/styles.css"
      provides: ".is-lifting CSS rules"
  key_links:
    - from: "interact.js move listener"
      to: "resolveCollisions"
      via: "Function call"
    - from: "resolveCollisions"
      to: "DOM elements style.top"
      via: "Direct manipulation for performance"
---

<objective>
Implement the core interactive "Push Physics" feature where dragging or resizing a task block automatically shifts subsequent blocks down to prevent overlaps.

Purpose: Provide an Apple-style, fluid experience for manual schedule adjustments.
Output: Collision resolution logic and enhanced drag-and-drop feedback.
</objective>

<execution_context>
@/Users/eyalatar/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/eyalatar/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/js/calendar.js
@frontend/js/interactions.js
@frontend/css/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement resolveCollisions Engine</name>
  <files>frontend/js/interactions.js</files>
  <action>
    Create a `resolveCollisions(blocks, movedBlockId)` function:
    1. Sort all blocks on the current day by `start_time`.
    2. Iterate through blocks starting from the `movedBlockId`.
    3. If a block overlaps with the previous one (`current.start < previous.end`):
       - Shift `current.start = previous.end`.
       - Keep `current.duration` constant.
       - If `current.end > 23:59`: mark as `is_delayed = true` and cap at midnight if necessary (but instructions say to "mark as Delayed rather than being squashed").
    4. Return the list of blocks with updated positions.
    
    Expose this function for use in both `move` and `end` interact.js listeners.
  </action>
  <verify>
    Calling `resolveCollisions` with overlapping test data returns a correctly shifted sequence.
  </verify>
  <done>Algorithm handles cascading shifts and midnight overflow correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Push Physics with Interact.js</name>
  <files>frontend/js/interactions.js</files>
  <action>
    Update `initInteractions()` in `interactions.js`:
    1. In `listeners: { move(event) }`:
       - Calculate the tentative new position of the dragged block.
       - Call `resolveCollisions` with the current blocks and the tentative move.
       - Directly update the `style.top` and `style.height` of *all affected blocks* in the DOM for real-time preview (performance optimization - don't re-render full grid).
    2. In `listeners: { end(event) }`:
       - Save the *entire shifted sequence* to the backend using the new PATCH endpoints (or a bulk update if possible, otherwise individual PATCHes for all affected blocks).
    
    Ensure `hold: 200` is active for mobile "lift" differentiation.
  </action>
  <verify>
    Dragging a task block on the UI causes subsequent blocks to slide down smoothly.
  </verify>
  <done>Real-time push physics are functional on desktop and simulated mobile.</done>
</task>

<task type="auto">
  <name>Task 3: Add "Lifting" Visual Polish</name>
  <files>frontend/css/styles.css, frontend/js/interactions.js</files>
  <action>
    1. Define `.is-lifting` in `styles.css`:
       - `transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);`
       - `transform: scale(1.02);`
       - `box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.3), 0 8px 10px -6px rgb(0 0 0 / 0.3);`
       - `z-index: 50;`
    2. Update `interactions.js` `start` listener to apply `.is-lifting` to the target.
    3. Remove it in `end` listener.
  </action>
  <verify>
    Long-pressing (mobile) or clicking (desktop) a block causes it to "lift" visually before moving.
  </verify>
  <done>Visual feedback matches iOS-style "lift" behavior.</done>
</task>

</tasks>

<verification>
Simulate a mobile device in Chrome DevTools (Responsive mode, Touch enabled). Test dragging blocks and verify the push behavior and visual feedback. Verify that the end of the day cap marks the last block as "delayed".
</verification>

<success_criteria>
Dragging one task block pushes all others down in real-time with smooth animation and persistent storage of all shifted positions.
</success_criteria>

<output>
After completion, create `.planning/phases/09-interactive-task-management/09-02-SUMMARY.md`
</output>
